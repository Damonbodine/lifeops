<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOps - Your Personal Operating System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 280px;
            height: 100vh;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 20px;
            z-index: 1000;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            margin: 5px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .nav-item:hover, .nav-item.active {
            background: rgba(255,255,255,0.1);
        }

        .nav-item span {
            margin-left: 10px;
        }

        .main-content {
            margin-left: 280px;
            padding: 20px;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255,255,255,0.95);
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9rem;
            text-transform: uppercase;
            font-weight: 600;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }

        .feature-card {
            background: rgba(255,255,255,0.95);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .feature-card h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Pomodoro Timer Styles */
        .timer-display {
            text-align: center;
            margin: 20px 0;
        }

        .timer-time {
            font-size: 4rem;
            font-weight: bold;
            color: #e74c3c;
            margin-bottom: 10px;
        }

        .timer-status {
            font-size: 1.2rem;
            color: #7f8c8d;
            margin-bottom: 20px;
        }

        .timer-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .intent-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ecf0f1;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        /* Task Queue Styles */
        .task-section {
            margin-bottom: 25px;
        }

        .task-section h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .task-input {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .task-input input {
            flex: 1;
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
        }

        .task-input button {
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .duration-select {
            padding: 10px;
            border: 2px solid #ecf0f1;
            border-radius: 6px;
            background: white;
            color: #2c3e50;
            font-size: 14px;
            min-width: 90px;
            cursor: pointer;
        }

        .duration-select:focus {
            outline: none;
            border-color: #3498db;
        }

        .task-list {
            list-style: none;
        }

        .task-item {
            display: flex;
            align-items: center;
            justify-content: between;
            padding: 12px;
            background: #f8f9fa;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }

        .task-item.big {
            border-left-color: #e74c3c;
        }

        .task-item.medium {
            border-left-color: #f39c12;
        }

        .task-item.small {
            border-left-color: #27ae60;
        }

        .task-text {
            flex: 1;
        }

        .task-delete {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #ecf0f1;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: #3498db;
            transition: width 0.3s;
        }

        .section-title {
            color: white;
            font-size: 1.5rem;
            margin-bottom: 20px;
            text-align: center;
        }

        /* Email Analysis Styles */
        .email-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .email-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .email-card:hover {
            transform: translateY(-5px);
        }

        .email-header {
            margin-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 15px;
        }

        .email-subject {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
        }

        .email-from {
            color: #7f8c8d;
            font-size: 0.95rem;
        }

        .email-summary {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }

        .priority {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin: 10px 0;
        }

        .priority.critical {
            background: #ffcdd2;
            color: #c62828;
            animation: pulse 1s infinite;
        }

        .priority.high {
            background: #ffebee;
            color: #c62828;
        }

        .priority.medium {
            background: #fff3e0;
            color: #ef6c00;
        }

        .priority.low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .category-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            margin: 5px 0;
            text-transform: capitalize;
        }

        .category-badge.work {
            background: #3498db;
            color: white;
        }

        .category-badge.personal {
            background: #9b59b6;
            color: white;
        }

        .category-badge.promotional {
            background: #e67e22;
            color: white;
        }

        .category-badge.social {
            background: #1abc9c;
            color: white;
        }

        .category-badge.other {
            background: #95a5a6;
            color: white;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .action-needed {
            margin: 10px 0;
            font-weight: 600;
        }

        .action-needed.yes {
            color: #e74c3c;
        }

        .action-needed.no {
            color: #27ae60;
        }

        .key-points {
            margin-top: 15px;
        }

        .key-points h4 {
            margin-bottom: 8px;
            color: #34495e;
        }

        .key-points ul {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            background: #ecf0f1;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 3px solid #9b59b6;
        }

        .action-items {
            margin: 15px 0;
        }

        .action-items h4 {
            color: #27ae60;
            margin: 0 0 10px 0;
            font-size: 0.9rem;
        }

        .action-items ul {
            list-style: none;
            padding: 0;
        }

        .action-items li {
            background: #e8f8f5;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 6px;
            border-left: 3px solid #27ae60;
        }

        .suggested-response {
            margin: 15px 0;
            background: #f0f8ff;
            padding: 10px;
            border-radius: 6px;
            border-left: 3px solid #3498db;
        }

        .suggested-response h4 {
            color: #3498db;
            margin: 0 0 8px 0;
            font-size: 0.9rem;
        }

        .suggested-response p {
            margin: 0;
            font-style: italic;
            color: #555;
        }

        /* Scrollable contacts styles */
        #priorityContacts::-webkit-scrollbar {
            width: 8px;
        }

        #priorityContacts::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #priorityContacts::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #priorityContacts::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .contact-item {
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .contact-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .contacts-header {
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
            padding-bottom: 10px;
            margin-bottom: 10px;
        }

        /* AI Chat Quick Widget for Dashboard */
        .chat-widget {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .chat-widget:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }

        .chat-widget h3 {
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .chat-widget p {
            margin-bottom: 20px;
            opacity: 0.9;
            line-height: 1.5;
        }

        .chat-widget-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .chat-widget-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        /* AI Schedule Preview Modal */
        .schedule-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .schedule-modal-content {
            background: white;
            border-radius: 16px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 20px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.3);
        }

        .schedule-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        .schedule-header h2 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .schedule-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 25px;
        }

        .schedule-timeline {
            margin: 20px 0;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            margin: 15px 0;
            padding: 15px;
            border-left: 4px solid #3498db;
            background: #f8f9fa;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .schedule-item:hover {
            transform: translateX(5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .schedule-item.big {
            border-left-color: #e74c3c;
            background: #ffebee;
        }

        .schedule-item.medium {
            border-left-color: #f39c12;
            background: #fff8e1;
        }

        .schedule-item.small {
            border-left-color: #27ae60;
            background: #e8f5e8;
        }

        .schedule-time {
            font-weight: bold;
            color: #2c3e50;
            min-width: 120px;
            font-size: 0.9rem;
        }

        .schedule-details {
            flex: 1;
            margin-left: 15px;
        }

        .schedule-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .schedule-task {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-bottom: 3px;
        }

        .schedule-reasoning {
            color: #9b59b6;
            font-size: 0.8rem;
            font-style: italic;
        }

        .energy-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: bold;
            margin-left: 10px;
        }

        .energy-badge.high {
            background: #ff6b6b;
            color: white;
        }

        .energy-badge.medium {
            background: #ffd93d;
            color: #333;
        }

        .energy-badge.low {
            background: #6bcf7f;
            color: white;
        }

        .schedule-tips {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .schedule-tips h4 {
            color: #2e7d32;
            margin-bottom: 10px;
        }

        .schedule-tips ul {
            margin: 0;
            padding-left: 20px;
        }

        .schedule-tips li {
            color: #2e7d32;
            margin: 5px 0;
        }

        .schedule-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
        }

        .schedule-confirm-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .schedule-confirm-btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .schedule-cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .schedule-cancel-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .loading-schedule {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .loading-schedule .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Schedule Editing Controls */
        .schedule-item.editable {
            position: relative;
            cursor: move;
        }

        .schedule-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .schedule-item:hover .schedule-controls {
            opacity: 1;
        }

        .control-btn {
            background: rgba(255,255,255,0.9);
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s;
        }

        .control-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .control-btn.remove {
            color: #e74c3c;
        }

        .control-btn.edit {
            color: #3498db;
        }

        .time-editor {
            display: none;
            background: white;
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .time-editor.active {
            display: block;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .time-input-group {
            display: flex;
            flex-direction: column;
        }

        .time-input-group label {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 5px;
        }

        .time-input-group input, .time-input-group select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .time-editor-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .time-save-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .time-cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .schedule-regenerate {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .regenerate-btn {
            background: #9b59b6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            margin: 0 5px;
        }

        .removed-item {
            opacity: 0.5;
            background: #f8f8f8 !important;
            border-left-color: #ccc !important;
        }

        .removed-item .schedule-details {
            text-decoration: line-through;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">üßê LifeOps</div>
        <div class="nav-item active" onclick="showSection('dashboard')">
            <span>üìä</span>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="showSection('pomodoro')">
            <span>üçÖ</span>
            <span>Smart Pomodoro</span>
        </div>
        <div class="nav-item" onclick="showSection('tasks')">
            <span>üìã</span>
            <span>1-3-5 Tasks</span>
        </div>
        <div class="nav-item" onclick="showSection('emails')">
            <span>üìß</span>
            <span>Email Analysis</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/health.html'">
            <span>üèÉ‚Äç‚ôÇÔ∏è</span>
            <span>Health Analytics</span>
        </div>
        <div class="nav-item" onclick="showSection('email-relationships')">
            <span>üß†</span>
            <span>Relationship Intelligence</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/calendar.html'">
            <span>üìÖ</span>
            <span>Calendar View</span>
        </div>
        <div class="nav-item" onclick="showSection('ai-score')">
            <span>ü§ñ</span>
            <span>AI Daily Score</span>
        </div>
        <div class="nav-item" onclick="showSection('check-ins')">
            <span>üíå</span>
            <span>Check In</span>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="header">
                <h1>Welcome to LifeOps</h1>
                <p>Your AI-powered productivity companion</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="focusTime">0</div>
                    <div class="stat-label">Minutes Focused Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedSessions">0</div>
                    <div class="stat-label">Pomodoro Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tasksCompleted">0</div>
                    <div class="stat-label">Tasks Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="productivityScore">85</div>
                    <div class="stat-label">AI Productivity Score</div>
                </div>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üî• Today's Focus</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%"></div>
                    </div>
                    <p>65% of daily focus goal achieved</p>
                </div>
                <div class="feature-card">
                    <h3>‚ö° Quick Actions</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showSection('pomodoro')">Start Focus Session</button>
                        <button class="btn btn-success" onclick="showSection('tasks')">Add Task</button>
                        <button class="btn" onclick="showSection('emails')" style="background: #9b59b6; color: white;">Check Emails</button>
                    </div>
                </div>

                <div class="chat-widget" onclick="window.location.href='/calendar.html'">
                    <h3>ü§ñ AI Calendar Assistant</h3>
                    <p>Schedule events using natural language! Just describe what you want to schedule and I'll handle the rest.</p>
                    <button class="chat-widget-btn">Try AI Scheduling ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Pomodoro Section -->
        <div id="pomodoro" class="section" style="display: none;">
            <h2 class="section-title">üçÖ Smart Pomodoro Timer</h2>
            
            <div class="feature-card">
                <div class="timer-display">
                    <div class="timer-time" id="timerDisplay">25:00</div>
                    <div class="timer-status" id="timerStatus">Ready to focus</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" class="intent-input" id="sessionIntent" placeholder="What's your focus intention for this session?">
                </div>

                <div class="timer-controls">
                    <button class="btn btn-success" id="startBtn" onclick="startTimer()">Start Session</button>
                    <button class="btn btn-danger" id="pauseBtn" onclick="pauseTimer()" style="display: none;">Pause</button>
                    <button class="btn" id="resetBtn" onclick="resetTimer()">Reset</button>
                    <button class="btn" id="testSoundBtn" onclick="playNotificationSound()" style="background: #9b59b6; color: white;">üîä Test Sound</button>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <p>Work Duration: <span id="sessionDurationLabel">25 minutes</span></p>
                    <input type="range" id="sessionDuration" min="1" max="90" value="25" oninput="updateDuration()" 
                           style="width: 100%; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #7f8c8d; margin-bottom: 20px;">
                        <span>1 min</span>
                        <span>25 min</span>
                        <span>45 min</span>
                        <span>90 min</span>
                    </div>
                    
                    <p>Break Duration: 
                        <select id="breakDuration">
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                        </select>
                    </p>
                </div>
            </div>

            <div class="feature-card" style="margin-top: 20px;">
                <h3>üìà Recent Sessions</h3>
                <div id="sessionHistory">
                    <div class="task-item">
                        <span>üî• Email Processing - 25 min</span>
                        <span style="margin-left: auto; color: #27ae60;">Completed</span>
                    </div>
                    <div class="task-item">
                        <span>üíª Code Review - 45 min</span>
                        <span style="margin-left: auto; color: #27ae60;">Completed</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks" class="section" style="display: none;">
            <h2 class="section-title">üìã 1-3-5 Task Queue</h2>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="task-section">
                        <h4>üî• 1 Big Task</h4>
                        <div class="task-input">
                            <input type="text" id="bigTaskInput" placeholder="Your most important task today">
                            <select id="bigTaskDuration" class="duration-select">
                                <option value="30">30 min</option>
                                <option value="60" selected>1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                                <option value="180">3 hours</option>
                                <option value="240">4 hours</option>
                            </select>
                            <button onclick="addTask('big')">Add</button>
                        </div>
                        <ul class="task-list" id="bigTasks"></ul>
                    </div>

                    <div class="task-section">
                        <h4>‚ö° 3 Medium Tasks</h4>
                        <div class="task-input">
                            <input type="text" id="mediumTaskInput" placeholder="Important but manageable task">
                            <select id="mediumTaskDuration" class="duration-select">
                                <option value="15">15 min</option>
                                <option value="30" selected>30 min</option>
                                <option value="45">45 min</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                            </select>
                            <button onclick="addTask('medium')">Add</button>
                        </div>
                        <ul class="task-list" id="mediumTasks"></ul>
                    </div>

                    <div class="task-section">
                        <h4>‚úÖ 5 Small Tasks</h4>
                        <div class="task-input">
                            <input type="text" id="smallTaskInput" placeholder="Quick win or small task">
                            <select id="smallTaskDuration" class="duration-select">
                                <option value="5">5 min</option>
                                <option value="10">10 min</option>
                                <option value="15" selected>15 min</option>
                                <option value="30">30 min</option>
                            </select>
                            <button onclick="addTask('small')">Add</button>
                        </div>
                        <ul class="task-list" id="smallTasks"></ul>
                    </div>
                </div>

                <div class="feature-card">
                    <h3>üéØ Today's Progress</h3>
                    <div style="margin: 20px 0;">
                        <p>Big Tasks: <span id="bigProgress">0/1</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bigProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        <p>Medium Tasks: <span id="mediumProgress">0/3</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="mediumProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        <p>Small Tasks: <span id="smallProgress">0/5</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="smallProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <div class="stat-number" id="overallProgress">0%</div>
                        <div class="stat-label">Overall Completion</div>
                    </div>

                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
                        <button class="btn btn-primary" onclick="scheduleTasksWithAI()" id="scheduleBtn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-size: 1rem; padding: 15px;">
                            ü§ñ Schedule All Tasks with AI
                        </button>
                        <p style="color: #7f8c8d; font-size: 0.85rem; text-align: center; margin: 10px 0 0 0;">AI will create optimal calendar blocks for your tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emails Section -->
        <div id="emails" class="section" style="display: none;">
            <h2 class="section-title">üìß Email Analysis</h2>
            
            <div class="feature-card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>ü§ñ AI Email Insights</h3>
                    <button class="btn btn-primary" onclick="analyzeEmails()">
                        üìß Analyze Recent Emails
                    </button>
                </div>
                
                <div id="email-loading" class="loading" style="display: none;">
                    ü§ñ AI is analyzing your emails...
                </div>
                
                <div id="email-status" style="display: none; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; margin: 15px 0;"></div>
            </div>
            
            <div id="email-grid" class="email-grid"></div>
        </div>

        <!-- Email Relationship Intelligence Section -->
        <div id="email-relationships" class="section" style="display: none;">
            <h2 class="section-title">üß† Email Relationship Intelligence</h2>
            
            <div class="feature-card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üì§ Sent Email Analysis</h3>
                    <button class="btn btn-primary" onclick="startRelationshipAnalysis()" id="analysisBtn">
                        üöÄ Analyze Sent Emails (5 Years)
                    </button>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; color: #2c3e50;">
                    <strong>üéØ Focus:</strong> Analyzes only emails you've sent to identify people you used to communicate with regularly but haven't contacted recently.
                </div>
                
                <div id="relationship-status" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #2c3e50; margin: 15px 0;">
                    <div id="status-content">Loading sent email analysis status...</div>
                </div>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üí§ People to Reconnect With</h3>
                    <div id="dormant-relationships" style="min-height: 200px;">
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                            <p>Discover people you used to email regularly<br>but haven't contacted lately</p>
                        </div>
                    </div>
                </div>

                <div class="feature-card">
                    <h3>üìä Communication Insights</h3>
                    <div id="relationship-insights" style="min-height: 200px;">
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üìà</div>
                            <p>Insights into your outbound communication patterns and relationship strength</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Score Section -->
        <div id="ai-score" class="section" style="display: none;">
            <h2 class="section-title">ü§ñ AI Daily Score & Insights</h2>
            
            <div class="feature-grid">
                <div class="feature-card" style="text-align: center;">
                    <h3>Today's Productivity Score</h3>
                    <div class="stat-number" style="font-size: 4rem; color: #27ae60;">85</div>
                    <p style="color: #7f8c8d;">Based on focus time, task completion, and email management</p>
                </div>

                <div class="feature-card">
                    <h3>üéØ AI Insights</h3>
                    <div style="line-height: 1.6;">
                        <p><strong>‚úÖ Strengths Today:</strong></p>
                        <ul style="margin: 10px 0 20px 20px;">
                            <li>Excellent focus session completion rate</li>
                            <li>Proactive email management</li>
                            <li>Good task prioritization</li>
                        </ul>
                        
                        <p><strong>üí° Improvement Opportunities:</strong></p>
                        <ul style="margin: 10px 0 20px 20px;">
                            <li>Consider longer focus blocks for deep work</li>
                            <li>Schedule email processing at specific times</li>
                            <li>Add more small wins to build momentum</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="feature-card" style="margin-top: 20px;">
                <h3>üìä This Week's Trends</h3>
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #7f8c8d;">Weekly analytics will appear here</p>
                    <p style="color: #7f8c8d;">Track your productivity patterns and improvements over time</p>
                </div>
            </div>
        </div>

        <!-- Check-ins Section -->
        <div id="check-ins" class="section" style="display: none;">
            <h2 class="section-title">üíå Relationship Check-ins</h2>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üéØ This Week's Goal</h3>
                    <p id="weeklyGoal" style="font-size: 1.1rem; line-height: 1.6; color: #2c3e50;">Loading your relationship insights...</p>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="loadCheckIns()">üîÑ Refresh Check-ins</button>
                    </div>
                </div>

                <div class="feature-card">
                    <h3>üë• Priority Check-ins</h3>
                    
                    <!-- Configuration Panel -->
                    <div id="configPanel" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #2c3e50; font-size: 16px;">üéØ Analysis Settings</h4>
                            <button id="toggleConfig" class="btn" style="font-size: 12px; padding: 4px 8px; margin-left: auto;" onclick="toggleConfigPanel()">‚öôÔ∏è Configure</button>
                        </div>
                        
                        <!-- Quick Presets -->
                        <div id="presetButtons" style="margin-bottom: 15px;">
                            <div style="margin-bottom: 8px; font-size: 14px; color: #7f8c8d;">Quick Presets:</div>
                            <div id="presetContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="preset-btn" onclick="loadPreset('recent-activity')" style="background: #FF6B6B; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üî• Recent</button>
                                <button class="preset-btn" onclick="loadPreset('catch-up-mode')" style="background: #4ECDC4; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üìû Catch-Up</button>
                                <button class="preset-btn" onclick="loadPreset('reconnect-deep')" style="background: #45B7D1; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üåä Deep</button>
                                <button class="preset-btn" onclick="loadPreset('high-frequency')" style="background: #96CEB4; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">‚ö° High Freq</button>
                                <button class="preset-btn" onclick="loadPreset('random-surprise')" style="background: #FECA57; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üé≤ Random</button>
                            </div>
                        </div>
                        
                        <!-- Detailed Controls -->
                        <div id="detailedControls" style="display: none; grid: auto / 1fr 1fr; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Days Since Last Contact:</label>
                                <select id="daysThreshold" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="1">1+ days (Very Recent)</option>
                                    <option value="7">7+ days (This Week)</option>
                                    <option value="14">14+ days (Two Weeks)</option>
                                    <option value="30" selected>30+ days (This Month)</option>
                                    <option value="60">60+ days (Two Months)</option>
                                    <option value="90">90+ days (Three Months)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Lookback Period:</label>
                                <select id="lookbackDays" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="180">Last 6 Months</option>
                                    <option value="365" selected>Last Year</option>
                                    <option value="730">Last 2 Years</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Sort By:</label>
                                <select id="sortBy" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="daysSince" selected>Days Since Contact</option>
                                    <option value="messageCount">Message Frequency</option>
                                    <option value="random">Random Order</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Contact Type:</label>
                                <select id="filterType" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="all" selected>All Contacts</option>
                                    <option value="resolved">Named Contacts Only</option>
                                    <option value="unresolved">Phone Numbers Only</option>
                                </select>
                            </div>
                            
                            <div style="grid-column: span 2;">
                                <button onclick="applyCustomConfig()" class="btn" style="width: 100%; background: #3498db; color: white; margin-top: 10px;">üîç Apply Custom Settings</button>
                            </div>
                        </div>
                        
                        <div id="currentConfig" style="margin-top: 10px; font-size: 12px; color: #7f8c8d; font-style: italic;"></div>
                    </div>
                    
                    <div id="contactsStats" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                        <span id="contactsCount" style="font-weight: bold; color: #2c3e50;"></span>
                        <span id="contactsInsight" style="color: #7f8c8d; margin-left: 10px;"></span>
                    </div>
                    <div id="priorityContacts" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                        <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                            <p>Analyzing your message history...</p>
                            <p>Finding friends you should reconnect with</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="feature-card" style="margin-top: 20px;">
                <h3>üì± Quick Actions</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button class="btn" style="background: #27ae60; color: white;" onclick="openMessages()">
                        üì± Open Messages App
                    </button>
                    <button class="btn" style="background: #3498db; color: white;" onclick="scheduleReminder()">
                        ‚è∞ Set Weekly Reminder
                    </button>
                    <button class="btn" style="background: #9b59b6; color: white;" onclick="exportContacts()">
                        üìã Export Contact List
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">üí° Pro Tips:</h4>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>Check in with close friends every 2-3 weeks</li>
                        <li>Send genuine, personal messages rather than generic "how are you?"</li>
                        <li>Reference shared memories or ask about specific things</li>
                        <li>Set a weekly goal to reach out to 2-3 people</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Schedule Preview Modal -->
    <div id="schedule-modal" class="schedule-modal">
        <div class="schedule-modal-content">
            <div id="schedule-loading" class="loading-schedule" style="display: none;">
                <div class="spinner"></div>
                <p>ü§ñ AI is analyzing your tasks and creating the optimal schedule...</p>
            </div>
            
            <div id="schedule-preview" style="display: none;">
                <div class="schedule-header">
                    <h2>üóìÔ∏è Your Optimized Task Schedule</h2>
                    <p style="color: #7f8c8d;">AI has created the perfect calendar layout for your productivity</p>
                </div>

                <div class="schedule-summary" id="schedule-summary-content">
                    <!-- Summary will be inserted here -->
                </div>

                <div class="schedule-regenerate">
                    <p style="color: #7f8c8d; margin: 0 0 10px 0;">Not happy with the schedule? Make adjustments or regenerate:</p>
                    <button class="regenerate-btn" onclick="regenerateSchedule()">üîÑ Generate New Schedule</button>
                    <button class="regenerate-btn" onclick="regenerateScheduleWithConstraints()">‚öôÔ∏è Regenerate with Preferences</button>
                </div>

                <div class="schedule-timeline" id="schedule-timeline">
                    <!-- Schedule items will be inserted here -->
                </div>

                <div class="schedule-tips" id="schedule-tips" style="display: none;">
                    <h4>üí° AI Productivity Tips</h4>
                    <ul id="schedule-tips-list">
                        <!-- Tips will be inserted here -->
                    </ul>
                </div>

                <div class="schedule-actions">
                    <button class="schedule-confirm-btn" onclick="confirmSchedule()">
                        ‚úÖ Schedule All Tasks
                    </button>
                    <button class="schedule-cancel-btn" onclick="closeScheduleModal()">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentSection = 'dashboard';
        let timerInterval = null;
        let timeRemaining = 25 * 60; // 25 minutes in seconds
        let isRunning = false;
        let completedSessions = 0;
        let totalFocusTime = 0;
        let currentCycle = 'work'; // 'work' or 'break'
        let cycleCount = 0;

        // Task storage
        let tasks = {
            big: [],
            medium: [],
            small: []
        };

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            // Show selected section
            document.getElementById(section).style.display = 'block';
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            currentSection = section;
            
            // Auto-load data for specific sections
            if (section === 'check-ins') {
                loadCheckIns();
            } else if (section === 'email-relationships') {
                loadRelationshipStatus();
            }

            // Show/hide email chat FAB based on section
            const emailChatFab = document.querySelector('.email-chat-fab');
            const emailChatContainer = document.getElementById('ai-email-chat');

            if (section === 'emails') {
                // Show FAB when in emails section
                if (emailChatFab) {
                    emailChatFab.style.display = 'block';
                }
            } else {
                // Hide FAB and close chat when not in emails section
                if (emailChatFab) {
                    emailChatFab.style.display = 'none';
                }
                if (emailChatContainer) {
                    emailChatContainer.style.display = 'none';
                    emailChatVisible = false; // Reset chat state
                }
            }
        }

        // Pomodoro Timer Functions
        function startTimer() {
            if (currentCycle === 'work') {
                const intent = document.getElementById('sessionIntent').value;
                if (!intent.trim()) {
                    alert('Please enter your focus intention first!');
                    return;
                }
                cycleCount++;
                document.getElementById('timerStatus').textContent = `Work Session #${cycleCount}: ${intent}`;
            } else {
                document.getElementById('timerStatus').textContent = `Break time! Cycle #${cycleCount}`;
            }

            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = 'Paused';
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            currentCycle = 'work';
            cycleCount = 0;
            const duration = parseInt(document.getElementById('sessionDuration').value);
            timeRemaining = duration * 60;
            updateTimerDisplay();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = 'Ready to focus';
            document.getElementById('sessionIntent').value = '';
        }

        // Sound notification function
        function playNotificationSound() {
            console.log('üîä Attempting to play notification sound...');
            
            try {
                // Create audio context if it doesn't exist
                if (!window.audioContext) {
                    window.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    console.log('üéµ Created new AudioContext');
                }
                
                // Resume audio context if suspended (required by modern browsers)
                if (window.audioContext.state === 'suspended') {
                    window.audioContext.resume().then(() => {
                        console.log('üéµ AudioContext resumed');
                        playActualSound();
                    });
                } else {
                    playActualSound();
                }
                
                function playActualSound() {
                    console.log('üéµ Playing synthesized ding...');
                    
                    // Create a simple ding sound using Web Audio API
                    const oscillator = window.audioContext.createOscillator();
                    const gainNode = window.audioContext.createGain();
                    
                    // Connect oscillator to gain to output
                    oscillator.connect(gainNode);
                    gainNode.connect(window.audioContext.destination);
                    
                    // Configure the ding sound
                    oscillator.frequency.setValueAtTime(800, window.audioContext.currentTime); // High pitch
                    oscillator.frequency.exponentialRampToValueAtTime(200, window.audioContext.currentTime + 0.1); // Drop to lower pitch
                    
                    // Configure volume envelope (fade in/out)
                    gainNode.gain.setValueAtTime(0, window.audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.3, window.audioContext.currentTime + 0.01);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, window.audioContext.currentTime + 0.5);
                    
                    // Play the sound
                    oscillator.start(window.audioContext.currentTime);
                    oscillator.stop(window.audioContext.currentTime + 0.5);
                    
                    console.log('‚úÖ Sound should be playing now');
                }
                
            } catch (error) {
                console.error('‚ùå Web Audio API failed:', error);
                
                // Fallback 1: Simple HTML5 audio with a beep
                try {
                    console.log('üîÑ Trying HTML5 audio fallback...');
                    const audio = new Audio();
                    audio.src = 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwgBTuV2++9diMFl1n19tOKOwgWNK/l7qRTFAy6lpGv7J1WEwx';
                    audio.volume = 0.5;
                    audio.play().then(() => {
                        console.log('‚úÖ HTML5 audio played successfully');
                    }).catch(audioError => {
                        console.error('‚ùå HTML5 audio failed:', audioError);
                        
                        // Fallback 2: Browser notification with sound
                        if ('Notification' in window) {
                            console.log('üîî Trying browser notification...');
                            if (Notification.permission === 'granted') {
                                new Notification('üçÖ Pomodoro Complete!', {
                                    body: 'Your focus session has finished.',
                                    icon: 'üçÖ',
                                    requireInteraction: true
                                });
                            } else if (Notification.permission !== 'denied') {
                                Notification.requestPermission().then(permission => {
                                    if (permission === 'granted') {
                                        new Notification('üçÖ Pomodoro Complete!', {
                                            body: 'Your focus session has finished.',
                                            icon: 'üçÖ',
                                            requireInteraction: true
                                        });
                                    }
                                });
                            }
                        }
                    });
                } catch (fallbackError) {
                    console.error('‚ùå All sound methods failed:', fallbackError);
                    // Visual feedback as last resort
                    document.body.style.backgroundColor = '#ff6b6b';
                    setTimeout(() => {
                        document.body.style.backgroundColor = '';
                    }, 500);
                }
            }
        }

        function completeSession() {
            clearInterval(timerInterval);
            isRunning = false;
            
            // Play notification sound
            playNotificationSound();
            
            if (currentCycle === 'work') {
                // Work session completed, start break
                cycleCount++;
                currentCycle = 'break';
                const breakMinutes = parseInt(document.getElementById('breakDuration').value);
                timeRemaining = breakMinutes * 60;
                
                // Update stats only for work sessions
                completedSessions++;
                const sessionMinutes = parseInt(document.getElementById('sessionDuration').value);
                totalFocusTime += sessionMinutes;
                
                // Update display
                document.getElementById('completedSessions').textContent = completedSessions;
                document.getElementById('focusTime').textContent = totalFocusTime;
                
                // Show break notification and start break automatically
                alert(`üéâ Work session completed! Starting ${breakMinutes}-minute break.`);
                document.getElementById('timerStatus').textContent = `Break time! Cycle #${cycleCount}`;
                updateTimerDisplay();
                
                // Auto-start break timer
                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'inline-block';
                
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        completeSession();
                    }
                }, 1000);
                
            } else {
                // Break completed, offer to continue or end
                currentCycle = 'work';
                const sessionMinutes = parseInt(document.getElementById('sessionDuration').value);
                timeRemaining = sessionMinutes * 60;
                
                const continueWork = confirm('‚òï Break complete! Ready to start another work session?');
                
                if (continueWork) {
                    // Start new work session
                    document.getElementById('timerStatus').textContent = `Ready for work session #${cycleCount + 1}`;
                    updateTimerDisplay();
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('pauseBtn').style.display = 'none';
                } else {
                    // End the session completely
                    resetTimer();
                    alert('üèÅ Pomodoro session ended. Great work today!');
                }
            }
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(timeRemaining / 60);
            const seconds = timeRemaining % 60;
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function updateDuration() {
            if (!isRunning) {
                const duration = parseInt(document.getElementById('sessionDuration').value);
                document.getElementById('sessionDurationLabel').textContent = `${duration} minutes`;
                timeRemaining = duration * 60;
                updateTimerDisplay();
            }
        }

        // Task Management Functions
        function addTask(type) {
            const input = document.getElementById(`${type}TaskInput`);
            const durationSelect = document.getElementById(`${type}TaskDuration`);
            const text = input.value.trim();
            const duration = parseInt(durationSelect.value);
            
            if (!text) return;

            // Check limits
            const limits = { big: 1, medium: 3, small: 5 };
            if (tasks[type].length >= limits[type]) {
                alert(`You can only have ${limits[type]} ${type} task(s)`);
                return;
            }

            const task = {
                id: Date.now(),
                text: text,
                duration: duration,
                completed: false,
                createdAt: new Date().toISOString()
            };

            tasks[type].push(task);
            input.value = '';
            renderTasks();
            updateProgress();
        }

        function deleteTask(type, id) {
            tasks[type] = tasks[type].filter(task => task.id !== id);
            renderTasks();
            updateProgress();
        }

        function toggleTask(type, id) {
            const task = tasks[type].find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
                updateProgress();
                updateCompletedTasks();
            }
        }

        function renderTasks() {
            ['big', 'medium', 'small'].forEach(type => {
                const container = document.getElementById(`${type}Tasks`);
                container.innerHTML = '';

                tasks[type].forEach(task => {
                    const li = document.createElement('li');
                    li.className = `task-item ${type}`;
                    
                    // Format duration display
                    const duration = task.duration || 0;
                    let durationText = '';
                    if (duration >= 60) {
                        const hours = Math.floor(duration / 60);
                        const mins = duration % 60;
                        durationText = mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
                    } else {
                        durationText = `${duration}m`;
                    }
                    
                    li.innerHTML = `
                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="toggleTask('${type}', ${task.id})" style="margin-right: 10px;">
                        <span class="task-text" style="${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.text}</span>
                        <span class="task-duration" style="color: #7f8c8d; font-size: 0.85em; margin-left: 10px;">${durationText}</span>
                        <button class="task-delete" onclick="deleteTask('${type}', ${task.id})">√ó</button>
                    `;
                    container.appendChild(li);
                });
            });
        }

        function updateProgress() {
            const limits = { big: 1, medium: 3, small: 5 };
            let totalCompleted = 0;
            let totalTasks = 0;

            ['big', 'medium', 'small'].forEach(type => {
                const completed = tasks[type].filter(task => task.completed).length;
                const total = tasks[type].length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;

                document.getElementById(`${type}Progress`).textContent = `${completed}/${total}`;
                document.getElementById(`${type}ProgressBar`).style.width = `${percentage}%`;

                totalCompleted += completed;
                totalTasks += total;
            });

            const overallPercentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
            document.getElementById('overallProgress').textContent = `${overallPercentage}%`;
        }

        function updateCompletedTasks() {
            const completed = Object.values(tasks).flat().filter(task => task.completed).length;
            document.getElementById('tasksCompleted').textContent = completed;
        }

        // Check-in Functions
        // Global configuration state
        let currentConfig = {
            daysThreshold: 30,
            lookbackDays: 365,
            maxContacts: 15,
            sortBy: 'daysSince',
            filterType: 'all',
            minMessages: 2
        };

        async function loadCheckIns(customConfig = null) {
            try {
                document.getElementById('weeklyGoal').textContent = 'Loading...';
                document.getElementById('priorityContacts').innerHTML = '<div style="text-align: center; color: #7f8c8d; padding: 20px;"><p>Analyzing your relationships...</p></div>';
                
                // Use custom config if provided, otherwise use current global config
                const config = customConfig || currentConfig;
                
                // Build query string
                const params = new URLSearchParams(config);
                const response = await fetch(`/api/check-ins?${params}`);
                const data = await response.json();
                
                // Update weekly goal
                document.getElementById('weeklyGoal').textContent = data.weeklyGoal;
                
                // Update contacts stats
                const statsElement = document.getElementById('contactsStats');
                const countElement = document.getElementById('contactsCount');
                const insightElement = document.getElementById('contactsInsight');
                
                if (data.totalContacts && data.totalContacts > 0) {
                    statsElement.style.display = 'block';
                    const filterText = data.resolvedContacts !== undefined ? 
                        `${data.priorityContacts.length} of ${data.totalContacts} contacts shown (${data.resolvedContacts} with resolved names)` :
                        `${data.priorityContacts.length} of ${data.totalContacts} contacts shown`;
                    countElement.textContent = filterText;
                    insightElement.textContent = data.insight || '';
                }
                
                // Update priority contacts with scrollable display
                const contactsContainer = document.getElementById('priorityContacts');
                if (data.priorityContacts && data.priorityContacts.length > 0) {
                    contactsContainer.innerHTML = `
                        <div class="contacts-header" style="margin-bottom: 15px;">
                            <small style="color: #7f8c8d;">Scroll to see more contacts ‚Üì</small>
                        </div>
                    ` + data.priorityContacts.map((contact, index) => {
                        const isBirthday = contact.birthdayContact;
                        const borderStyle = isBirthday ? 'border: 3px solid #FFD700; background: linear-gradient(135deg, #FFF9E6 0%, #FFFBF0 100%);' : '';
                        const priorityBadge = isBirthday ? 
                            '<span style="background: #FFD700; color: #B8860B; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; margin-left: 5px; font-weight: bold;">üéÇ BIRTHDAY</span>' :
                            `<span style="background: #f0f0f0; padding: 2px 6px; border-radius: 10px; font-size: 0.8rem; margin-left: 8px;">#${index + 1}</span>`;
                        
                        const daysSinceText = isBirthday ? 
                            (contact.birthdayInfo && contact.birthdayInfo.daysUntilBirthday === 0 ? 
                                'üéâ Birthday is TODAY!' : 
                                `üéÇ Birthday in ${contact.birthdayInfo?.daysUntilBirthday || 0} days`) :
                            `üìÖ ${contact.daysSince} days since last contact`;
                            
                        const daysSinceColor = isBirthday ? '#D4AF37' : '#e74c3c';
                        
                        return `
                        <div class="contact-item task-item" style="margin: 0; padding: 15px; ${borderStyle}">
                            <div style="flex: 1;">
                                <div style="font-weight: bold; margin-bottom: 5px;">
                                    ${contact.isResolved ? 'üë§' : 'üì±'} ${contact.name}
                                    ${priorityBadge}
                                    ${contact.isResolved ? 
                                        '<span style="background: #e8f5e8; color: #2e7d32; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">‚úì Named</span>' : 
                                        '<span style="background: #fff3e0; color: #ef6c00; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 5px;">üìû Number</span>'
                                    }
                                    ${isBirthday && contact.birthdayInfo?.facebookUrl ? 
                                        `<a href="${contact.birthdayInfo.facebookUrl}" target="_blank" style="margin-left: 5px; text-decoration: none;">
                                            <span style="background: #1877F2; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem;">üìò FB</span>
                                        </a>` : ''
                                    }
                                </div>
                                <div style="color: ${daysSinceColor}; font-size: 0.9rem; margin-bottom: 5px; font-weight: ${isBirthday ? 'bold' : 'normal'};">
                                    ${daysSinceText}
                                </div>
                                <div style="color: #7f8c8d; font-size: 0.9rem; margin-bottom: 10px;">
                                    ${contact.reason}
                                    ${contact.messageCount ? `‚Ä¢ ${contact.messageCount} messages total` : ''}
                                </div>
                                <div style="background: ${isBirthday ? '#FFF9E6' : '#f8f9fa'}; padding: 10px; border-radius: 6px; font-style: italic; border-left: ${isBirthday ? '4px solid #FFD700' : '4px solid #e9ecef'};">
                                    üí¨ "${contact.suggestedMessage}"
                                </div>
                            </div>
                            <button class="btn btn-success" onclick="sendMessage('${contact.name}', '${contact.rawContact}', '${contact.isResolved}')" style="margin-left: 15px; white-space: nowrap;">
                                üíå Message
                            </button>
                            <button class="btn" onclick="getSmartMessage('${contact.name}', '${contact.rawContact}', '${contact.isResolved}')" style="margin-left: 10px; white-space: nowrap; background: #9b59b6; color: white;">
                                ü§ñ Smart Message
                            </button>
                        </div>`
                    }).join('');
                } else {
                    contactsContainer.innerHTML = `
                        <div style="text-align: center; color: #27ae60; padding: 20px;">
                            <p>üéâ You're doing great at staying connected!</p>
                            <p>No urgent check-ins needed right now.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading check-ins:', error);
                document.getElementById('priorityContacts').innerHTML = `
                    <div style="text-align: center; color: #e74c3c; padding: 20px;">
                        <p>‚ùå Error loading check-ins</p>
                        <p>Make sure LifeOps has Full Disk Access permission</p>
                    </div>
                `;
            }
        }

        async function sendMessage(contactName, rawContact, isResolved) {
            try {
                console.log(`üì± Opening Messages for: ${contactName} (${rawContact})`);
                
                const response = await fetch('/api/open-messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        contact: contactName,
                        rawContact: rawContact,
                        name: contactName,
                        isResolved: isResolved === 'true'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show detailed success message
                    const button = event.target;
                    const originalText = button.textContent;
                    
                    // Update button with success state
                    button.textContent = '‚úì Opened!';
                    button.style.background = '#27ae60';
                    
                    // Show detailed feedback
                    console.log(`‚úÖ Messages opened successfully:`, result);
                    
                    // Create floating success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #27ae60;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        z-index: 1000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        max-width: 300px;
                        font-size: 14px;
                    `;
                    
                    const methodText = {
                        'applescript': 'üçé via AppleScript',
                        'sms_url': 'üîó via SMS URL',
                        'app_only': 'üì± opened Messages app'
                    };
                    
                    successMsg.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px;">üíå Messages Opened!</div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            Contact: ${contactName}<br>
                            Method: ${methodText[result.method] || result.method}<br>
                            ${result.target ? `Target: ${result.target}` : ''}
                        </div>
                    `;
                    
                    document.body.appendChild(successMsg);
                    
                    // Auto-remove success message
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 4000);
                    
                    // Reset button
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#27ae60';
                    }, 2000);
                    
                } else {
                    console.error('‚ùå Failed to open Messages:', result);
                    alert(`Could not open Messages app for ${contactName}. Please try manually.\n\nError: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error opening Messages:', error);
                alert('Error opening Messages app. Please try manually.');
            }
        }

        async function getSmartMessage(contactName, rawContact, isResolved) {
            try {
                console.log(`ü§ñ Getting smart message for: ${contactName} (${rawContact})`);
                
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'ü§ñ Analyzing...';
                button.disabled = true;
                
                const response = await fetch('/api/smart-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phoneNumber: rawContact,
                        contactName: contactName,
                        daysBack: 30,
                        birthdayContact: event.target.closest('.contact-item').querySelector('[style*="BIRTHDAY"]') !== null,
                        specialOccasion: event.target.closest('.contact-item').querySelector('[style*="BIRTHDAY"]') ? 'birthday' : null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Create modal to show smart message suggestions
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        border-radius: 12px;
                        padding: 30px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    `;
                    
                    const analysis = result.analysis;
                    modalContent.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #9b59b6;">ü§ñ Smart Message for ${contactName}</h2>
                            <button onclick="this.closest('.modal').remove(); event.stopPropagation();" style="background: none; border: none; font-size: 24px; cursor: pointer; margin-left: auto;">√ó</button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #666;">üìä Relationship Context</h4>
                            ${analysis.relationship ? `
                                <p style="margin: 5px 0;"><strong>Known each other:</strong> ${analysis.relationship.years_known} years</p>
                                <p style="margin: 5px 0;"><strong>Total messages:</strong> ${analysis.relationship.total_messages}</p>
                                <p style="margin: 5px 0;"><strong>Last contact:</strong> ${analysis.relationship.days_since_last} days ago</p>
                                <p style="margin: 5px 0;"><strong>Balance:</strong> ${analysis.relationship.conversation_balance}</p>
                                <p style="margin: 5px 0;"><strong>Relationship type:</strong> ${analysis.relationshipType || analysis.relationship.analysis_type}</p>
                            ` : `
                                <p style="margin: 5px 0;"><strong>Messages Found:</strong> ${analysis.messageCount || 0} messages</p>
                                <p style="margin: 5px 0;"><strong>Balance:</strong> ${analysis.conversationBalance || 'No data'}</p>
                            `}
                            <p style="margin: 5px 0;"><strong>Topics:</strong> ${analysis.topics || 'General conversation'}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #333;">üí¨ Suggested Messages</h4>
                            ${analysis.suggestions.map((suggestion, index) => `
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent;" 
                                     onclick="copyToClipboard('${suggestion.replace(/'/g, "\\'")}', this)" 
                                     onmouseover="this.style.borderColor='#27ae60'" 
                                     onmouseout="this.style.borderColor='transparent'">
                                    <div style="font-weight: 500; margin-bottom: 5px;">Option ${index + 1}</div>
                                    <div>"${suggestion}"</div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">Click to copy</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; padding-top: 15px; border-top: 1px solid #eee;">
                            <button onclick="sendMessage('${contactName}', '${rawContact}', '${isResolved}'); this.closest('.modal').remove();" 
                                    style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                üíå Open Messages
                            </button>
                            <button onclick="this.closest('.modal').remove();" 
                                    style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                } else {
                    console.error('‚ùå Failed to get smart message:', result);
                    alert(`Could not analyze conversation for ${contactName}.\n\nError: ${result.error || 'Unknown error'}`);
                }
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
            } catch (error) {
                console.error('Error getting smart message:', error);
                alert('Error analyzing conversation. Please try manually.');
                
                // Reset button
                const button = event.target;
                button.textContent = 'ü§ñ Smart Message';
                button.disabled = false;
            }
        }

        // Helper function to copy text to clipboard
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const originalBg = element.style.background;
                element.style.background = '#d4edda';
                element.innerHTML = element.innerHTML.replace('Click to copy', '‚úÖ Copied!');
                
                setTimeout(() => {
                    element.style.background = originalBg;
                    element.innerHTML = element.innerHTML.replace('‚úÖ Copied!', 'Click to copy');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                
                element.innerHTML = element.innerHTML.replace('Click to copy', '‚úÖ Copied!');
                setTimeout(() => {
                    element.innerHTML = element.innerHTML.replace('‚úÖ Copied!', 'Click to copy');
                }, 2000);
            });
        }

        async function openMessages() {
            try {
                const response = await fetch('/api/open-messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contact: '' }) // Empty contact = just open Messages
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert('Could not open Messages app');
                }
            } catch (error) {
                console.error('Error opening Messages:', error);
                alert('Error opening Messages app');
            }
        }

        function scheduleReminder() {
            // Set a weekly reminder using macOS notifications
            alert('‚è∞ Weekly relationship check-in reminder set!\n\nYou\'ll get notified every Monday at 9 AM to review your relationships.');
            
            // In a real implementation, you'd use:
            // - macOS Calendar app to create recurring event
            // - LaunchAgent for system-level notifications
            // - or Electron's notification API
        }

        function exportContacts() {
            // Export priority contacts as a simple list
            loadCheckIns().then(() => {
                const contacts = document.querySelectorAll('#priorityContacts .task-item');
                let exportText = "LifeOps Relationship Check-in List\n";
                exportText += "Generated: " + new Date().toLocaleDateString() + "\n\n";
                
                contacts.forEach((contact, index) => {
                    const name = contact.querySelector('div:first-child div:first-child').textContent.replace('üë§ ', '');
                    const days = contact.querySelector('div:first-child div:nth-child(2)').textContent;
                    exportText += `${index + 1}. ${name} - ${days}\n`;
                });
                
                // Create downloadable file
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lifeops-checkins.txt';
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        // AI Task Scheduler Functions
        let pendingSchedule = null;
        let currentScheduleData = null;
        let editingItemIndex = null;

        async function scheduleTasksWithAI() {
            // Check if there are any tasks to schedule
            const totalTasks = Object.values(tasks).flat().length;
            if (totalTasks === 0) {
                alert('Please add some tasks first before scheduling!');
                return;
            }

            // Show modal and loading state
            document.getElementById('schedule-modal').style.display = 'flex';
            document.getElementById('schedule-loading').style.display = 'block';
            document.getElementById('schedule-preview').style.display = 'none';
            
            try {
                const response = await fetch('/api/ai-schedule-tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        tasks: tasks,
                        preferences: {
                            workingHours: '9 AM - 6 PM',
                            energyPreference: 'High energy tasks in morning, lighter tasks in afternoon'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentScheduleData = data;
                    displaySchedulePreview(data);
                    pendingSchedule = data.formatted_events;
                } else {
                    throw new Error(data.message || 'Failed to create schedule');
                }
                
            } catch (error) {
                console.error('Error creating schedule:', error);
                alert('Sorry, I had trouble creating your schedule. Please try again.');
                closeScheduleModal();
            } finally {
                document.getElementById('schedule-loading').style.display = 'none';
            }
        }

        function displaySchedulePreview(scheduleData) {
            document.getElementById('schedule-preview').style.display = 'block';
            
            // Update summary
            const summaryContent = document.getElementById('schedule-summary-content');
            summaryContent.innerHTML = `
                <h3 style="margin: 0 0 10px 0;">üìä Schedule Overview</h3>
                <p style="margin: 5px 0;"><strong>Total Time:</strong> ${scheduleData.total_time}</p>
                <p style="margin: 5px 0;"><strong>Events:</strong> ${scheduleData.events_count} calendar blocks</p>
                <p style="margin: 10px 0 0 0;">${scheduleData.summary}</p>
            `;
            
            // Update timeline with editing controls
            const timeline = document.getElementById('schedule-timeline');
            timeline.innerHTML = scheduleData.schedule.map((item, index) => {
                const startDate = new Date(`${item.start_date}T${item.start_time}`);
                const endDate = new Date(`${item.end_date}T${item.end_time}`);
                const timeStr = `${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                return `
                    <div class="schedule-item editable ${item.task_type}" data-index="${index}" ${item.removed ? 'style="display: none;"' : ''}>
                        <div class="schedule-controls">
                            <div class="control-btn edit" onclick="editScheduleItem(${index})" title="Edit time">‚è∞</div>
                            <div class="control-btn remove" onclick="removeScheduleItem(${index})" title="Remove task">√ó</div>
                        </div>
                        <div class="schedule-time">${timeStr}</div>
                        <div class="schedule-details">
                            <div class="schedule-title">${item.title}</div>
                            <div class="schedule-task">üìã ${item.task_text}</div>
                            <div class="schedule-reasoning">üí° ${item.reasoning}</div>
                        </div>
                        <div class="energy-badge ${item.energy_level}">${item.energy_level.toUpperCase()}</div>
                        
                        <div class="time-editor" id="editor-${index}">
                            <div class="time-inputs">
                                <div class="time-input-group">
                                    <label>Start Date</label>
                                    <input type="date" id="start-date-${index}" value="${item.start_date}">
                                </div>
                                <div class="time-input-group">
                                    <label>Start Time</label>
                                    <input type="time" id="start-time-${index}" value="${item.start_time}">
                                </div>
                                <div class="time-input-group">
                                    <label>Duration</label>
                                    <select id="duration-${index}">
                                        <option value="15" ${item.duration_minutes === 15 ? 'selected' : ''}>15 min</option>
                                        <option value="30" ${item.duration_minutes === 30 ? 'selected' : ''}>30 min</option>
                                        <option value="45" ${item.duration_minutes === 45 ? 'selected' : ''}>45 min</option>
                                        <option value="60" ${item.duration_minutes === 60 ? 'selected' : ''}>1 hour</option>
                                        <option value="90" ${item.duration_minutes === 90 ? 'selected' : ''}>1.5 hours</option>
                                        <option value="120" ${item.duration_minutes === 120 ? 'selected' : ''}>2 hours</option>
                                        <option value="180" ${item.duration_minutes === 180 ? 'selected' : ''}>3 hours</option>
                                        <option value="240" ${item.duration_minutes === 240 ? 'selected' : ''}>4 hours</option>
                                    </select>
                                </div>
                            </div>
                            <div class="time-editor-actions">
                                <button class="time-save-btn" onclick="saveScheduleEdit(${index})">Save</button>
                                <button class="time-cancel-btn" onclick="cancelScheduleEdit(${index})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update tips
            if (scheduleData.tips && scheduleData.tips.length > 0) {
                document.getElementById('schedule-tips').style.display = 'block';
                document.getElementById('schedule-tips-list').innerHTML = 
                    scheduleData.tips.map(tip => `<li>${tip}</li>`).join('');
            }
        }

        async function confirmSchedule() {
            if (!pendingSchedule) return;
            
            try {
                const confirmBtn = document.querySelector('.schedule-confirm-btn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Creating Events...';
                
                const response = await fetch('/api/ai-schedule-tasks/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ events: pendingSchedule })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    alert(`üéâ ${data.summary}\n\nYour calendar has been updated with optimized task blocks!`);
                    
                    // Close modal
                    closeScheduleModal();
                    
                    // Optionally clear completed tasks or mark them as scheduled
                    // markTasksAsScheduled();
                    
                } else {
                    throw new Error(data.message || 'Failed to create calendar events');
                }
                
            } catch (error) {
                console.error('Error confirming schedule:', error);
                alert('Sorry, there was an error creating your calendar events. Please try again.');
            } finally {
                const confirmBtn = document.querySelector('.schedule-confirm-btn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '‚úÖ Schedule All Tasks';
            }
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
            pendingSchedule = null;
            currentScheduleData = null;
            editingItemIndex = null;
        }

        // Schedule Editing Functions
        function editScheduleItem(index) {
            // Close any other open editors
            document.querySelectorAll('.time-editor').forEach(editor => {
                editor.classList.remove('active');
            });
            
            // Open this editor
            const editor = document.getElementById(`editor-${index}`);
            editor.classList.add('active');
            editingItemIndex = index;
        }

        function cancelScheduleEdit(index) {
            const editor = document.getElementById(`editor-${index}`);
            editor.classList.remove('active');
            editingItemIndex = null;
        }

        function saveScheduleEdit(index) {
            const startDate = document.getElementById(`start-date-${index}`).value;
            const startTime = document.getElementById(`start-time-${index}`).value;
            const duration = parseInt(document.getElementById(`duration-${index}`).value);
            
            // Update the schedule data
            const item = currentScheduleData.schedule[index];
            item.start_date = startDate;
            item.start_time = startTime;
            item.duration_minutes = duration;
            
            // Calculate new end time
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
            item.end_date = endDateTime.toISOString().split('T')[0];
            item.end_time = endDateTime.toTimeString().slice(0, 5);
            
            // Update the formatted events for calendar creation
            updateFormattedEvents();
            
            // Refresh the display
            displaySchedulePreview(currentScheduleData);
            
            // Close editor
            cancelScheduleEdit(index);
        }

        function removeScheduleItem(index) {
            if (confirm('Remove this task from the schedule?')) {
                // Mark as removed
                currentScheduleData.schedule[index].removed = true;
                
                // Update formatted events
                updateFormattedEvents();
                
                // Update the display
                const item = document.querySelector(`[data-index="${index}"]`);
                item.classList.add('removed-item');
                item.style.display = 'none';
                
                // Update summary
                updateScheduleSummary();
            }
        }

        function updateFormattedEvents() {
            // Regenerate formatted events from current schedule data
            pendingSchedule = currentScheduleData.schedule
                .filter(item => !item.removed)
                .map(item => ({
                    summary: item.title,
                    description: `üìã Task: ${item.task_text}\n\nüß† Energy Level: ${item.energy_level}\nüí° Reasoning: ${item.reasoning}`,
                    start: new Date(`${item.start_date}T${item.start_time}`).toISOString(),
                    end: new Date(`${item.end_date}T${item.end_time}`).toISOString(),
                    colorId: item.task_type === 'big' ? '11' : item.task_type === 'medium' ? '9' : '2',
                    extendedProperties: {
                        private: {
                            lifeops_task_id: item.task_id,
                            lifeops_task_type: item.task_type,
                            lifeops_energy_level: item.energy_level
                        }
                    }
                }));
        }

        function updateScheduleSummary() {
            const activeItems = currentScheduleData.schedule.filter(item => !item.removed);
            const totalMinutes = activeItems.reduce((sum, item) => sum + item.duration_minutes, 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const totalTime = hours > 0 ? `${hours} hours ${minutes} minutes` : `${minutes} minutes`;
            
            currentScheduleData.total_time = totalTime;
            currentScheduleData.events_count = activeItems.length;
            
            // Update summary display
            const summaryContent = document.getElementById('schedule-summary-content');
            summaryContent.innerHTML = `
                <h3 style="margin: 0 0 10px 0;">üìä Schedule Overview</h3>
                <p style="margin: 5px 0;"><strong>Total Time:</strong> ${totalTime}</p>
                <p style="margin: 5px 0;"><strong>Events:</strong> ${activeItems.length} calendar blocks</p>
                <p style="margin: 10px 0 0 0;">${currentScheduleData.summary}</p>
            `;
        }

        async function regenerateSchedule() {
            // Just call the original scheduling function again
            document.getElementById('schedule-loading').style.display = 'block';
            document.getElementById('schedule-preview').style.display = 'none';
            
            try {
                const response = await fetch('/api/ai-schedule-tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        tasks: tasks,
                        preferences: {
                            workingHours: '9 AM - 6 PM',
                            energyPreference: 'High energy tasks in morning, lighter tasks in afternoon'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentScheduleData = data;
                    displaySchedulePreview(data);
                    pendingSchedule = data.formatted_events;
                }
                
            } catch (error) {
                console.error('Error regenerating schedule:', error);
                alert('Sorry, I had trouble regenerating your schedule.');
            } finally {
                document.getElementById('schedule-loading').style.display = 'none';
            }
        }

        async function regenerateScheduleWithConstraints() {
            // This could open a preferences dialog in the future
            const workingHours = prompt('Preferred working hours (e.g., "8 AM - 5 PM"):', '9 AM - 6 PM');
            const energyPreference = prompt('Energy preference:', 'High energy tasks in morning, lighter tasks in afternoon');
            
            if (workingHours) {
                document.getElementById('schedule-loading').style.display = 'block';
                document.getElementById('schedule-preview').style.display = 'none';
                
                try {
                    const response = await fetch('/api/ai-schedule-tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            tasks: tasks,
                            preferences: {
                                workingHours: workingHours,
                                energyPreference: energyPreference
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        currentScheduleData = data;
                        displaySchedulePreview(data);
                        pendingSchedule = data.formatted_events;
                    }
                    
                } catch (error) {
                    console.error('Error regenerating schedule:', error);
                    alert('Sorry, I had trouble regenerating your schedule.');
                } finally {
                    document.getElementById('schedule-loading').style.display = 'none';
                }
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('schedule-modal');
            if (event.target === modal) {
                closeScheduleModal();
            }
        });

        // Email Analysis Functions
        async function analyzeEmails() {
            const loading = document.getElementById('email-loading');
            const emailGrid = document.getElementById('email-grid');
            const status = document.getElementById('email-status');
            const btn = event.target;

            // Show loading state
            btn.disabled = true;
            btn.textContent = 'Analyzing...';
            loading.style.display = 'block';
            emailGrid.innerHTML = '';
            status.style.display = 'none';

            try {
                const response = await fetch('/api/emails');
                const data = await response.json();

                if (data.error) {
                    status.innerHTML = `Gmail Error: ${data.error}`;
                    status.style.display = 'block';
                }

                if (data.emails && data.emails.length > 0) {
                    displayEmails(data.emails);
                } else {
                    status.innerHTML = 'No emails found to analyze';
                    status.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                status.innerHTML = '‚ùå Error analyzing emails. Please try again.';
                status.style.display = 'block';
            } finally {
                // Reset loading state
                btn.disabled = false;
                btn.textContent = 'üìß Analyze Recent Emails';
                loading.style.display = 'none';
            }
        }

        function displayEmails(emails) {
            const emailGrid = document.getElementById('email-grid');
            
            emails.forEach(email => {
                const card = document.createElement('div');
                card.className = 'email-card';
                
                card.innerHTML = `
                    <div class="email-header">
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-from">From: ${email.from}</div>
                    </div>
                    
                    <div class="email-summary">
                        <strong>ü§ñ AI Summary:</strong><br>
                        ${email.summary}
                    </div>
                    
                    <div>
                        <span class="priority ${email.urgency ? email.urgency.toLowerCase() : 'medium'}">
                            ‚ö° ${email.urgency || 'Medium'} Priority
                        </span>
                    </div>
                    
                    <div class="category-badge ${email.category ? email.category.toLowerCase() : 'other'}">
                        üìÇ ${email.category || 'Other'}
                    </div>
                    
                    <div class="action-needed ${email.requiresResponse ? 'yes' : 'no'}">
                        üéØ Response Needed: ${email.requiresResponse ? 'Yes' : 'No'}
                    </div>
                    
                    ${email.keyPoints && email.keyPoints.length > 0 ? `
                        <div class="key-points">
                            <h4>üîë Key Points:</h4>
                            <ul>
                                ${email.keyPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${email.actionItems && email.actionItems.length > 0 ? `
                        <div class="action-items">
                            <h4>‚úÖ Action Items:</h4>
                            <ul>
                                ${email.actionItems.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${email.suggestedResponse ? `
                        <div class="suggested-response">
                            <h4>üí¨ Suggested Response:</h4>
                            <p>${email.suggestedResponse}</p>
                        </div>
                    ` : ''}
                `;
                
                emailGrid.appendChild(card);
            });
        }

        // Email AI Chat Functions
        let emailChatVisible = false;
        let conversationHistory = [];

        function toggleEmailChat() {
            const chatContainer = document.getElementById('ai-email-chat');
            const chatFab = document.querySelector('.email-chat-fab');
            
            emailChatVisible = !emailChatVisible;
            
            if (emailChatVisible) {
                chatContainer.style.display = 'flex';
                chatFab.style.display = 'none';
                document.getElementById('email-chat-input').focus();
            } else {
                chatContainer.style.display = 'none';
                chatFab.style.display = 'block';
            }
        }

        function handleEmailChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendEmailChatMessage();
            }
        }

        async function sendEmailChatMessage() {
            const input = document.getElementById('email-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input and add user message
            input.value = '';
            addEmailMessage('user', message);
            
            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            showEmailTypingIndicator();
            
            try {
                const response = await fetch('/api/ai-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        conversationHistory: conversationHistory 
                    })
                });
                
                const data = await response.json();
                hideEmailTypingIndicator();
                
                // Add to conversation history
                conversationHistory.push({ role: 'assistant', content: data.response });
                
                // Add AI response
                addEmailMessage('ai', data.response);
                
                // Handle different actions
                if (data.action === 'draft' && data.email_details) {
                    showEmailDraftConfirmation(data.email_details);
                } else if (data.action === 'confirm') {
                    // This could trigger actual email sending
                    addEmailMessage('ai', 'Email functionality ready for implementation!');
                } else if (data.serviceStatus && !data.serviceStatus.serviceReady) {
                    addEmailMessage('ai', 'Please ensure OpenAI API key and Gmail authentication are properly configured.');
                }
                
            } catch (error) {
                console.error('Email chat error:', error);
                hideEmailTypingIndicator();
                addEmailMessage('ai', "I'm having trouble processing your request. Please try again.");
            }
        }

        function addEmailMessage(sender, content) {
            const messagesContainer = document.getElementById('email-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 'üë§' : 'üìß';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showEmailDraftConfirmation(emailDetails) {
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'email-draft-confirmation';
            confirmationDiv.innerHTML = `
                <div class="draft-preview">
                    <h4>üìù Email Draft Preview</h4>
                    <div class="draft-details">
                        <p><strong>To:</strong> ${emailDetails.recipient || 'Not specified'}</p>
                        <p><strong>Subject:</strong> ${emailDetails.subject || 'No subject'}</p>
                        <div class="draft-body">
                            <strong>Body:</strong>
                            <div class="body-preview">${emailDetails.body || 'No content'}</div>
                        </div>
                        <p><strong>Tone:</strong> ${emailDetails.tone || 'professional'}</p>
                        <p><strong>Priority:</strong> ${emailDetails.priority || 'medium'}</p>
                    </div>
                    <div class="draft-actions">
                        <button onclick="sendEmailDraft()" class="draft-btn send">Send Email</button>
                        <button onclick="editEmailDraft()" class="draft-btn edit">Edit Draft</button>
                        <button onclick="cancelEmailDraft()" class="draft-btn cancel">Cancel</button>
                    </div>
                </div>
            `;
            
            const messagesContainer = document.getElementById('email-chat-messages');
            messagesContainer.appendChild(confirmationDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendEmailDraft() {
            addEmailMessage('ai', 'Email sending functionality will be implemented soon! Your draft looks great.');
        }

        function editEmailDraft() {
            addEmailMessage('ai', 'What changes would you like me to make to the email?');
        }

        function cancelEmailDraft() {
            addEmailMessage('ai', 'Draft cancelled. How else can I help with your emails?');
        }

        function showEmailTypingIndicator() {
            document.getElementById('email-typing-indicator').style.display = 'flex';
            const messagesContainer = document.getElementById('email-chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideEmailTypingIndicator() {
            document.getElementById('email-typing-indicator').style.display = 'none';
        }

        // Email Relationship Intelligence Functions
        async function loadRelationshipStatus() {
            try {
                const response = await fetch('/api/email-relationships/status');
                const status = await response.json();
                
                const statusContent = document.getElementById('status-content');
                const analysisBtn = document.getElementById('analysisBtn');
                
                if (status.processing) {
                    const proc = status.processing;
                    if (proc.status === 'running') {
                        statusContent.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <div>
                                    <strong>Analysis in Progress</strong><br>
                                    üìß Processed: ${proc.emails_processed || 0} emails<br>
                                    ‚è±Ô∏è Started: ${new Date(proc.start_date).toLocaleString()}<br>
                                    <span style="color: #27ae60; font-size: 0.9rem;">üí° Showing partial results below while processing continues</span>
                                </div>
                            </div>
                        `;
                        analysisBtn.disabled = true;
                        analysisBtn.textContent = '‚è≥ Processing...';
                        
                        // Load partial results immediately, even while processing
                        loadDormantRelationships();
                        loadRelationshipInsights();
                    } else if (proc.status === 'completed') {
                        statusContent.innerHTML = `
                            <div>
                                <strong>‚úÖ Analysis Complete!</strong><br>
                                üìß Processed: ${proc.emails_processed || 0} emails<br>
                                üèÅ Completed: ${new Date(proc.end_date).toLocaleString()}
                            </div>
                        `;
                        analysisBtn.textContent = 'üîÑ Re-analyze Sent Emails';
                        analysisBtn.disabled = false;
                        
                        // Load final results
                        loadDormantRelationships();
                        loadRelationshipInsights();
                    }
                } else {
                    statusContent.innerHTML = `
                        <div>
                            <strong>üöÄ Ready to Start</strong><br>
                            Click "Analyze Sent Emails" to process your outbound email history and discover people to reconnect with.
                        </div>
                    `;
                    analysisBtn.disabled = false;
                }
            } catch (error) {
                console.error('Error loading relationship status:', error);
                document.getElementById('status-content').innerHTML = `
                    <div style="color: #ff6b6b;">
                        ‚ùå Error loading status. Please try again.
                    </div>
                `;
            }
        }

        async function startRelationshipAnalysis() {
            const btn = document.getElementById('analysisBtn');
            const statusContent = document.getElementById('status-content');
            
            try {
                btn.disabled = true;
                btn.textContent = 'üöÄ Starting...';
                
                statusContent.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div>Starting analysis of your sent emails...</div>
                    </div>
                `;
                
                const response = await fetch('/api/email-relationships/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ yearsBack: 5 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusContent.innerHTML = `
                        <div>
                            <strong>‚úÖ Analysis Started!</strong><br>
                            Processing ${result.yearsBack} years of sent emails. This should be much faster!
                        </div>
                    `;
                    
                    btn.textContent = '‚è≥ Processing...';
                    
                    // Poll for status updates
                    pollRelationshipStatus();
                } else {
                    throw new Error(result.message || 'Failed to start analysis');
                }
            } catch (error) {
                console.error('Error starting relationship analysis:', error);
                statusContent.innerHTML = `
                    <div style="color: #ff6b6b;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'üöÄ Analyze Sent Emails (5 Years)';
            }
        }

        function pollRelationshipStatus() {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/email-relationships/status');
                    const status = await response.json();
                    
                    if (status.processing && status.processing.status === 'completed') {
                        clearInterval(pollInterval);
                        loadRelationshipStatus();
                    } else if (status.processing && status.processing.status === 'running') {
                        const statusContent = document.getElementById('status-content');
                        const proc = status.processing;
                        statusContent.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <div>
                                    <strong>Analysis in Progress</strong><br>
                                    üìß Processed: ${proc.emails_processed || 0} emails<br>
                                    ‚è±Ô∏è Running for: ${Math.round((new Date() - new Date(proc.start_date)) / 60000)} minutes<br>
                                    <span style="color: #27ae60; font-size: 0.9rem;">üí° Results updating in real-time below</span>
                                </div>
                            </div>
                        `;
                        
                        // Update results every few polling cycles (every 15 seconds)
                        if (Math.random() < 0.3) { // 30% chance each poll = ~every 15 seconds
                            loadDormantRelationships();
                            loadRelationshipInsights();
                        }
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                    clearInterval(pollInterval);
                }
            }, 5000); // Poll every 5 seconds
        }

        async function loadDormantRelationships() {
            try {
                const response = await fetch('/api/email-relationships/dormant?days=30&minEmailsSent=3');
                const data = await response.json();
                
                const container = document.getElementById('dormant-relationships');
                
                // Check if we got an error response
                if (data.error) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                            ‚ùå ${data.error}<br>
                            <small>${data.message || ''}</small>
                        </div>
                    `;
                    return;
                }
                
                // Handle the API response format {success: true, suggestions: [...]}
                const relationships = data.suggestions || data || [];
                
                if (relationships.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">‚úÖ</div>
                            <p>Great! You're staying in touch well.<br>No neglected connections found.</p>
                        </div>
                    `;
                    return;
                }
                
                container.innerHTML = relationships.map(rel => `
                    <div style="background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 8px; border-left: 4px solid #e74c3c;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <strong>${rel.name || rel.email}</strong><br>
                                <small style="color: #7f8c8d;">${rel.email}</small>
                                ${rel.lastSubject ? `<br><small style="color: #95a5a6; font-style: italic;">"${rel.lastSubject}"</small>` : ''}
                            </div>
                            <div style="text-align: right; font-size: 0.9rem; color: #7f8c8d;">
                                ${rel.daysSinceLastContact} days ago<br>
                                Health: ${rel.healthScore}/100<br>
                                <span style="color: #3498db; font-weight: bold;">${rel.suggestion_reason}</span>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button onclick="suggestMessage('${rel.email}')" style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                                üí° Suggest Message
                            </button>
                        </div>
                    </div>
                `).join('');
                
            } catch (error) {
                console.error('Error loading dormant relationships:', error);
                document.getElementById('dormant-relationships').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                        ‚ùå Error loading dormant relationships
                    </div>
                `;
            }
        }

        async function loadRelationshipInsights() {
            try {
                const response = await fetch('/api/email-relationships/insights');
                const data = await response.json();
                
                const container = document.getElementById('relationship-insights');
                
                // Check if we got an error response
                if (data.error) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                            ‚ùå ${data.error}<br>
                            <small>${data.message || ''}</small>
                        </div>
                    `;
                    return;
                }
                
                const insights = data.insights || {};
                
                container.innerHTML = `
                    <div style="padding: 20px;">
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìä Communication Overview</h4>
                            <div style="font-size: 0.9rem; line-height: 1.5;">
                                ‚Ä¢ <strong>${insights.overview?.totalRelationships || 0}</strong> relationships tracked<br>
                                ‚Ä¢ <strong>${insights.dormantRelationships?.count || 0}</strong> need attention<br>
                                ‚Ä¢ Database: <strong>${insights.overview?.databaseSize || 'Unknown'}</strong>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üí° AI Recommendations</h4>
                            <div style="font-size: 0.85rem; line-height: 1.4;">
                                ${insights.recommendations?.map(rec => `‚Ä¢ ${rec}`).join('<br>') || 'No recommendations available'}
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üéØ Quick Actions</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="loadDormantRelationships()" style="background: #e74c3c; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    üîç View ${insights.dormantRelationships?.count || 0} Dormant
                                </button>
                                <button onclick="loadRelationshipStatus()" style="background: #27ae60; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading relationship insights:', error);
                document.getElementById('relationship-insights').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                        ‚ùå Error loading insights
                    </div>
                `;
            }
        }

        async function suggestMessage(emailAddress) {
            try {
                // Find the relationship card for this email
                const relationshipCards = document.querySelectorAll('[id^="relationship-card-"]');
                let targetCard = null;
                
                relationshipCards.forEach(card => {
                    if (card.innerHTML.includes(emailAddress)) {
                        targetCard = card;
                    }
                });
                
                if (!targetCard) {
                    // Fallback: find by email in any element
                    const allCards = document.querySelectorAll('.dormant-relationships > div');
                    allCards.forEach(card => {
                        if (card.innerHTML.includes(emailAddress)) {
                            targetCard = card;
                        }
                    });
                }
                
                // Show loading state inline
                const suggestBtn = event.target;
                const originalText = suggestBtn.textContent;
                suggestBtn.disabled = true;
                suggestBtn.innerHTML = '‚è≥ Generating...';
                
                // Add loading container after the button
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;';
                loadingDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: #2c3e50;">
                        <div style="width: 16px; height: 16px; border: 2px solid #3498db; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span>ü§ñ Analyzing conversation history and generating personalized message...</span>
                    </div>
                `;
                suggestBtn.parentNode.appendChild(loadingDiv);
                
                const response = await fetch('/api/email-relationships/suggest-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ emailAddress })
                });
                
                const result = await response.json();
                
                // Remove loading div
                loadingDiv.remove();
                
                if (result.success && result.suggestion) {
                    const suggestion = result.suggestion;
                    
                    // Create inline suggestion display
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.style.cssText = 'margin-top: 15px; padding: 20px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;';
                    suggestionDiv.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #27ae60;">ü§ñ AI-Generated Reconnection Email</h4>
                            <button onclick="this.parentNode.parentNode.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #7f8c8d;">√ó</button>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Subject:</strong> ${suggestion.subject}<br>
                            <small style="color: #7f8c8d;">Context: ${suggestion.context.daysSinceLastContact} days since last contact ‚Ä¢ ${suggestion.context.totalEmailsSent} emails sent historically</small>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 6px; white-space: pre-line; line-height: 1.5; margin-bottom: 15px;">
${suggestion.body}
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="copyToClipboard(\`${suggestion.subject}\`, \`${suggestion.body.replace(/`/g, '\\`')}\`)" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                üìã Copy Email
                            </button>
                            <button onclick="openEmailClient('${emailAddress}', \`${suggestion.subject}\`, \`${suggestion.body.replace(/`/g, '\\`')}\`)" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                üìß Open in Email Client
                            </button>
                        </div>
                    `;
                    
                    suggestBtn.parentNode.appendChild(suggestionDiv);
                    
                    // Reset button
                    suggestBtn.disabled = false;
                    suggestBtn.innerHTML = '‚úÖ Generated';
                    suggestBtn.style.background = '#27ae60';
                    
                    // Scroll suggestion into view
                    suggestionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                } else {
                    // Reset button and show error
                    suggestBtn.disabled = false;
                    suggestBtn.textContent = originalText;
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #ffe6e6; border-radius: 8px; border-left: 4px solid #e74c3c; color: #c0392b;';
                    errorDiv.innerHTML = `‚ùå ${result.error || 'Unable to generate message suggestion'}`;
                    suggestBtn.parentNode.appendChild(errorDiv);
                    
                    // Auto-remove error after 5 seconds
                    setTimeout(() => errorDiv.remove(), 5000);
                }
                
            } catch (error) {
                console.error('Error getting message suggestion:', error);
                
                // Reset button and show error
                const suggestBtn = event.target;
                suggestBtn.disabled = false;
                suggestBtn.textContent = 'üí° Suggest Message';
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #ffe6e6; border-radius: 8px; border-left: 4px solid #e74c3c; color: #c0392b;';
                errorDiv.innerHTML = `‚ùå Error generating suggestion. Please try again.`;
                suggestBtn.parentNode.appendChild(errorDiv);
                
                // Auto-remove error after 5 seconds
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }

        function copyToClipboard(subject, body) {
            const emailText = `Subject: ${subject}\n\n${body}`;
            navigator.clipboard.writeText(emailText).then(() => {
                // Show success feedback
                event.target.innerHTML = '‚úÖ Copied!';
                setTimeout(() => {
                    event.target.innerHTML = 'üìã Copy Email';
                }, 2000);
            });
        }

        function openEmailClient(email, subject, body) {
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTimerDisplay();
            renderTasks();
            updateProgress();
            
            // Auto-load check-ins when section is first visited
            if (currentSection === 'check-ins') {
                loadCheckIns();
            }

            // Auto-resize email chat input
            const emailChatInput = document.getElementById('email-chat-input');
            if (emailChatInput) {
                emailChatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                });
            }
        });

        // Configuration Management Functions
        let presets = {};

        async function loadPresets() {
            try {
                const response = await fetch('/api/check-ins/presets');
                const data = await response.json();
                if (data.success) {
                    presets = data.presets;
                }
            } catch (error) {
                console.error('Error loading presets:', error);
            }
        }

        function toggleConfigPanel() {
            const detailedControls = document.getElementById('detailedControls');
            const toggleBtn = document.getElementById('toggleConfig');
            
            if (detailedControls.style.display === 'none') {
                detailedControls.style.display = 'grid';
                toggleBtn.textContent = '‚¨ÜÔ∏è Hide';
                
                // Populate current values
                document.getElementById('daysThreshold').value = currentConfig.daysThreshold;
                document.getElementById('lookbackDays').value = currentConfig.lookbackDays;
                document.getElementById('sortBy').value = currentConfig.sortBy;
                document.getElementById('filterType').value = currentConfig.filterType;
            } else {
                detailedControls.style.display = 'none';
                toggleBtn.textContent = '‚öôÔ∏è Configure';
            }
        }

        async function loadPreset(presetKey) {
            try {
                console.log(`üìã Loading preset: ${presetKey}`);
                
                if (!presets[presetKey]) {
                    await loadPresets();
                }
                
                const preset = presets[presetKey];
                if (!preset) {
                    console.error('Preset not found:', presetKey);
                    return;
                }
                
                // Update current config
                currentConfig = { ...preset.config };
                
                // Update UI to show what's happening
                updateConfigDisplay(preset.name, preset.description);
                
                // Apply the preset
                await loadCheckIns(currentConfig);
                
                // Highlight the active preset button
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                });
                
                const activeBtn = document.querySelector(`[onclick="loadPreset('${presetKey}')"]`);
                if (activeBtn) {
                    activeBtn.style.opacity = '1';
                    activeBtn.style.transform = 'scale(1.05)';
                    activeBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                }
                
            } catch (error) {
                console.error('Error loading preset:', error);
            }
        }

        function applyCustomConfig() {
            // Get values from form
            const newConfig = {
                daysThreshold: parseInt(document.getElementById('daysThreshold').value),
                lookbackDays: parseInt(document.getElementById('lookbackDays').value),
                maxContacts: 15, // Keep this fixed for now
                sortBy: document.getElementById('sortBy').value,
                filterType: document.getElementById('filterType').value,
                minMessages: 2 // Keep this fixed for now
            };
            
            // Update global config
            currentConfig = newConfig;
            
            // Update display
            updateConfigDisplay('Custom Configuration', getConfigDescription(newConfig));
            
            // Apply changes
            loadCheckIns(currentConfig);
            
            // Reset preset button highlights
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = 'none';
            });
        }

        function updateConfigDisplay(title, description) {
            const currentConfigDiv = document.getElementById('currentConfig');
            currentConfigDiv.innerHTML = `<strong>${title}:</strong> ${description}`;
        }

        function getConfigDescription(config) {
            const parts = [];
            
            if (config.daysThreshold === 1) {
                parts.push('showing very recent contacts');
            } else if (config.daysThreshold <= 7) {
                parts.push('showing recent contacts');
            } else if (config.daysThreshold <= 30) {
                parts.push('showing contacts from past month');
            } else {
                parts.push(`showing contacts not contacted in ${config.daysThreshold}+ days`);
            }
            
            if (config.sortBy === 'messageCount') {
                parts.push('sorted by message frequency');
            } else if (config.sortBy === 'random') {
                parts.push('in random order');
            } else {
                parts.push('sorted by time since last contact');
            }
            
            if (config.filterType === 'resolved') {
                parts.push('(named contacts only)');
            } else if (config.filterType === 'unresolved') {
                parts.push('(phone numbers only)');
            }
            
            return parts.join(', ');
        }

        // Load presets when page loads
        loadPresets();

    </script>

    <!-- Email AI Chat FAB - Only show on emails section -->
    <button class="email-chat-fab" id="email-chat-fab" onclick="toggleEmailChat()" title="Ask AI to help with emails" style="display: none;">
        üìß
    </button>

    <!-- Email AI Chat Container -->
    <div id="ai-email-chat" class="ai-chat-container">
        <div class="chat-header">
            <h3>üìß AI Email Assistant</h3>
            <button class="chat-close" onclick="toggleEmailChat()">√ó</button>
        </div>
        
        <div class="chat-messages" id="email-chat-messages">
            <!-- Initial AI greeting message -->
            <div class="message ai">
                <div class="message-avatar">üìß</div>
                <div class="message-content">
                    Hi! I'm your AI email assistant. I can help you compose emails, reply to messages, and manage your inbox using natural language. Try saying:
                    <br><br>
                    ‚Ä¢ "Draft an email to John about the project update"
                    ‚Ä¢ "Help me reply to Sarah's message about the meeting"
                    ‚Ä¢ "Compose a professional follow-up email"
                    ‚Ä¢ "Write a thank you email to the team"
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="email-typing-indicator">
            <div class="message-avatar">üìß</div>
            <div>
                AI is thinking
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea 
                id="email-chat-input" 
                class="chat-input" 
                placeholder="Tell me what email you'd like to create..."
                onkeypress="handleEmailChatKeyPress(event)"
                rows="1"
            ></textarea>
        </div>
    </div>

    <style>
        /* Email Chat FAB Styles */
        .email-chat-fab {
            position: fixed;
            bottom: 20px;
            right: 20px; /* Bottom-right position like calendar */
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
            transition: all 0.3s;
            z-index: 999;
        }

        .email-chat-fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 25px rgba(0,0,0,0.4);
        }

        /* Email Chat Container */
        .ai-chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px; /* Bottom-right position like calendar */
            width: 400px;
            height: 500px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            z-index: 1000;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .chat-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .chat-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            gap: 10px;
            max-width: 80%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.ai {
            align-self: flex-start;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
            background: #28a745;
            color: white;
        }

        .message.user .message-avatar {
            background: #007bff;
        }

        .message-content {
            background: #f8f9fa;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #007bff;
            color: white;
        }

        .message.ai .message-content {
            background: #e8f5e8;
            color: #2c3e50;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            color: #7f8c8d;
            font-style: italic;
            font-size: 0.85rem;
            padding: 0 20px;
        }

        .typing-dots {
            display: flex;
            gap: 3px;
        }

        .typing-dots span {
            width: 4px;
            height: 4px;
            background: #7f8c8d;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .chat-input-container {
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            background: #f8f9fa;
        }

        .chat-input {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 0.9rem;
            outline: none;
            resize: none;
            min-height: 20px;
            max-height: 80px;
        }

        .chat-input:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.2);
        }

        /* Email Draft Preview Styles */
        .email-draft-confirmation {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }

        .draft-preview h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }

        .draft-details {
            margin: 10px 0;
            font-size: 0.9rem;
        }

        .draft-details p {
            margin: 5px 0;
        }

        .body-preview {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            margin-top: 5px;
            max-height: 100px;
            overflow-y: auto;
        }

        .draft-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .draft-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .draft-btn.send {
            background: #28a745;
            color: white;
        }

        .draft-btn.edit {
            background: #ffc107;
            color: #212529;
        }

        .draft-btn.cancel {
            background: #6c757d;
            color: white;
        }

        .draft-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
    </style>
</body>
</html>