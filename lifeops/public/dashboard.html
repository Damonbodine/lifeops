<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeOps - Your Personal Operating System</title>
    <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
    <div class="sidebar">
        <div class="logo">üßê LifeOps</div>
        <div class="nav-item active" onclick="showSection('dashboard')">
            <span>üìä</span>
            <span>Dashboard</span>
        </div>
        <div class="nav-item" onclick="showSection('pomodoro')">
            <span>üçÖ</span>
            <span>Smart Pomodoro</span>
        </div>
        <div class="nav-item" onclick="showSection('tasks')">
            <span>üìã</span>
            <span>1-3-5 Tasks</span>
        </div>
        <div class="nav-item" onclick="showSection('emails')">
            <span>üìß</span>
            <span>Email Analysis</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/health.html'">
            <span>üèÉ‚Äç‚ôÇÔ∏è</span>
            <span>Health Analytics</span>
        </div>
        <div class="nav-item" onclick="showSection('email-relationships')">
            <span>üß†</span>
            <span>Relationship Intelligence</span>
        </div>
        <div class="nav-item" onclick="window.location.href='/calendar.html'">
            <span>üìÖ</span>
            <span>Calendar View</span>
        </div>
        <div class="nav-item" onclick="showSection('ai-score')">
            <span>ü§ñ</span>
            <span>AI Daily Score</span>
        </div>
        <div class="nav-item" onclick="showSection('check-ins')">
            <span>üíå</span>
            <span>Check In</span>
        </div>
    </div>

    <div class="main-content">
        <!-- Dashboard Section -->
        <div id="dashboard" class="section">
            <div class="header">
                <h1>Welcome to LifeOps</h1>
                <p>Your AI-powered productivity companion</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="focusTime">0</div>
                    <div class="stat-label">Minutes Focused Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="completedSessions">0</div>
                    <div class="stat-label">Pomodoro Sessions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tasksCompleted">0</div>
                    <div class="stat-label">Tasks Completed</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="productivityScore">85</div>
                    <div class="stat-label">AI Productivity Score</div>
                </div>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üî• Today's Focus</h3>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: 65%"></div>
                    </div>
                    <p>65% of daily focus goal achieved</p>
                </div>
                <div class="feature-card">
                    <h3>‚ö° Quick Actions</h3>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="showSection('pomodoro')">Start Focus Session</button>
                        <button class="btn btn-success" onclick="showSection('tasks')">Add Task</button>
                        <button class="btn" onclick="showSection('emails')" style="background: #9b59b6; color: white;">Check Emails</button>
                    </div>
                </div>

                <div class="chat-widget" id="productivity-orchestrator">
                    <h3>üß† AI Productivity Orchestrator</h3>
                    <p>Let AI build your perfect day! Get personalized interviews, data analysis, and automated scheduling with Pomodoro integration.</p>
                    <div class="orchestrator-controls">
                        <button class="orchestrator-btn primary" onclick="startDailyOrchestration()">üöÄ Start My Day</button>
                        <button class="orchestrator-btn secondary" onclick="showOrchestrationStatus()">üìä View Status</button>
                    </div>
                    <div id="orchestration-status" class="orchestration-status" style="display: none;">
                        <div class="status-grid">
                            <div class="status-item">
                                <span class="status-icon">üó£Ô∏è</span>
                                <span class="status-label">Interview</span>
                                <span class="status-value" id="interview-status">Ready</span>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">üìä</span>
                                <span class="status-label">Data Collection</span>
                                <span class="status-value" id="data-status">Ready</span>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">üß†</span>
                                <span class="status-label">Analysis</span>
                                <span class="status-value" id="analysis-status">Ready</span>
                            </div>
                            <div class="status-item">
                                <span class="status-icon">üèóÔ∏è</span>
                                <span class="status-label">Schedule</span>
                                <span class="status-value" id="schedule-status">Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pomodoro Section -->
        <div id="pomodoro" class="section" style="display: none;">
            <h2 class="section-title">üçÖ Smart Pomodoro Timer</h2>
            
            <div class="feature-card">
                <div class="timer-display">
                    <div class="timer-time" id="timerDisplay">25:00</div>
                    <div class="timer-status" id="timerStatus">Ready to focus</div>
                </div>

                <div style="margin-bottom: 20px;">
                    <input type="text" class="intent-input" id="sessionIntent" placeholder="What's your focus intention for this session?">
                </div>

                <div class="timer-controls">
                    <button class="btn btn-success" id="startBtn" onclick="startTimer()">Start Session</button>
                    <button class="btn btn-danger" id="pauseBtn" onclick="pauseTimer()" style="display: none;">Pause</button>
                    <button class="btn" id="resetBtn" onclick="resetTimer()">Reset</button>
                    <button class="btn" id="testSoundBtn" onclick="playNotificationSound()" style="background: #9b59b6; color: white;">üîä Test Sound</button>
                </div>

                <div style="margin-top: 20px; text-align: center;">
                    <p>Work Duration: <span id="sessionDurationLabel">25 minutes</span></p>
                    <input type="range" id="sessionDuration" min="1" max="90" value="25" oninput="updateDuration()" 
                           style="width: 100%; margin: 10px 0;">
                    <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #7f8c8d; margin-bottom: 20px;">
                        <span>1 min</span>
                        <span>25 min</span>
                        <span>45 min</span>
                        <span>90 min</span>
                    </div>
                    
                    <p>Break Duration: 
                        <select id="breakDuration">
                            <option value="5">5 minutes</option>
                            <option value="10">10 minutes</option>
                            <option value="15">15 minutes</option>
                            <option value="30">30 minutes</option>
                        </select>
                    </p>
                </div>
            </div>

            <div class="feature-card" style="margin-top: 20px;">
                <h3>üìà Recent Sessions</h3>
                <div id="sessionHistory">
                    <div class="task-item">
                        <span>üî• Email Processing - 25 min</span>
                        <span style="margin-left: auto; color: #27ae60;">Completed</span>
                    </div>
                    <div class="task-item">
                        <span>üíª Code Review - 45 min</span>
                        <span style="margin-left: auto; color: #27ae60;">Completed</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tasks Section -->
        <div id="tasks" class="section" style="display: none;">
            <h2 class="section-title">üìã 1-3-5 Task Queue</h2>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <div class="task-section">
                        <h4>üî• 1 Big Task</h4>
                        <div class="task-input">
                            <input type="text" id="bigTaskInput" placeholder="Your most important task today">
                            <select id="bigTaskDuration" class="duration-select">
                                <option value="30">30 min</option>
                                <option value="60" selected>1 hour</option>
                                <option value="90">1.5 hours</option>
                                <option value="120">2 hours</option>
                                <option value="180">3 hours</option>
                                <option value="240">4 hours</option>
                            </select>
                            <button onclick="addTask('big')">Add</button>
                        </div>
                        <ul class="task-list" id="bigTasks"></ul>
                    </div>

                    <div class="task-section">
                        <h4>‚ö° 3 Medium Tasks</h4>
                        <div class="task-input">
                            <input type="text" id="mediumTaskInput" placeholder="Important but manageable task">
                            <select id="mediumTaskDuration" class="duration-select">
                                <option value="15">15 min</option>
                                <option value="30" selected>30 min</option>
                                <option value="45">45 min</option>
                                <option value="60">1 hour</option>
                                <option value="90">1.5 hours</option>
                            </select>
                            <button onclick="addTask('medium')">Add</button>
                        </div>
                        <ul class="task-list" id="mediumTasks"></ul>
                    </div>

                    <div class="task-section">
                        <h4>‚úÖ 5 Small Tasks</h4>
                        <div class="task-input">
                            <input type="text" id="smallTaskInput" placeholder="Quick win or small task">
                            <select id="smallTaskDuration" class="duration-select">
                                <option value="5">5 min</option>
                                <option value="10">10 min</option>
                                <option value="15" selected>15 min</option>
                                <option value="30">30 min</option>
                            </select>
                            <button onclick="addTask('small')">Add</button>
                        </div>
                        <ul class="task-list" id="smallTasks"></ul>
                    </div>
                </div>

                <div class="feature-card">
                    <h3>üéØ Today's Progress</h3>
                    <div style="margin: 20px 0;">
                        <p>Big Tasks: <span id="bigProgress">0/1</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="bigProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        <p>Medium Tasks: <span id="mediumProgress">0/3</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="mediumProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    <div style="margin: 20px 0;">
                        <p>Small Tasks: <span id="smallProgress">0/5</span></p>
                        <div class="progress-bar">
                            <div class="progress-fill" id="smallProgressBar" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <div class="stat-number" id="overallProgress">0%</div>
                        <div class="stat-label">Overall Completion</div>
                    </div>

                    <div style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #ecf0f1;">
                        <button class="btn btn-primary" onclick="scheduleTasksWithAI()" id="scheduleBtn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; font-size: 1rem; padding: 15px;">
                            ü§ñ Schedule All Tasks with AI
                        </button>
                        <p style="color: #7f8c8d; font-size: 0.85rem; text-align: center; margin: 10px 0 0 0;">AI will create optimal calendar blocks for your tasks</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emails Section -->
        <div id="emails" class="section" style="display: none;">
            <h2 class="section-title">üìß Email Analysis</h2>
            
            <div class="feature-card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>ü§ñ AI Email Insights</h3>
                    <button class="btn btn-primary" onclick="analyzeEmails()">
                        üìß Analyze Recent Emails
                    </button>
                </div>
                
                <div id="email-loading" class="loading" style="display: none;">
                    ü§ñ AI is analyzing your emails...
                </div>
                
                <div id="email-status" style="display: none; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; color: white; margin: 15px 0;"></div>
            </div>
            
            <div id="email-grid" class="email-grid"></div>
        </div>

        <!-- Email Relationship Intelligence Section -->
        <div id="email-relationships" class="section" style="display: none;">
            <h2 class="section-title">üß† Email Relationship Intelligence</h2>
            
            <div class="feature-card" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3>üì§ Sent Email Analysis</h3>
                    <button class="btn btn-primary" onclick="startRelationshipAnalysis()" id="analysisBtn">
                        üöÄ Analyze Sent Emails (5 Years)
                    </button>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 0.9rem; color: #2c3e50;">
                    <strong>üéØ Focus:</strong> Analyzes only emails you've sent to identify people you used to communicate with regularly but haven't contacted recently.
                </div>
                
                <div id="relationship-status" style="padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; color: #2c3e50; margin: 15px 0;">
                    <div id="status-content">Loading sent email analysis status...</div>
                </div>
            </div>

            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üí§ People to Reconnect With</h3>
                    <div id="dormant-relationships" style="min-height: 200px;">
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üë•</div>
                            <p>Discover people you used to email regularly<br>but haven't contacted lately</p>
                        </div>
                    </div>
                </div>

                <div class="feature-card">
                    <h3>üìä Communication Insights</h3>
                    <div id="relationship-insights" style="min-height: 200px;">
                        <div style="text-align: center; padding: 40px; color: #7f8c8d;">
                            <div style="font-size: 2rem; margin-bottom: 10px;">üìà</div>
                            <p>Insights into your outbound communication patterns and relationship strength</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Score Section -->
        <div id="ai-score" class="section" style="display: none;">
            <h2 class="section-title">ü§ñ AI Daily Score & Insights</h2>
            
            <div class="feature-grid">
                <div class="feature-card" style="text-align: center;">
                    <h3>Today's Productivity Score</h3>
                    <div class="stat-number" style="font-size: 4rem; color: #27ae60;">85</div>
                    <p style="color: #7f8c8d;">Based on focus time, task completion, and email management</p>
                </div>

                <div class="feature-card">
                    <h3>üéØ AI Insights</h3>
                    <div style="line-height: 1.6;">
                        <p><strong>‚úÖ Strengths Today:</strong></p>
                        <ul style="margin: 10px 0 20px 20px;">
                            <li>Excellent focus session completion rate</li>
                            <li>Proactive email management</li>
                            <li>Good task prioritization</li>
                        </ul>
                        
                        <p><strong>üí° Improvement Opportunities:</strong></p>
                        <ul style="margin: 10px 0 20px 20px;">
                            <li>Consider longer focus blocks for deep work</li>
                            <li>Schedule email processing at specific times</li>
                            <li>Add more small wins to build momentum</li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="feature-card" style="margin-top: 20px;">
                <h3>üìä This Week's Trends</h3>
                <div style="text-align: center; padding: 20px;">
                    <p style="color: #7f8c8d;">Weekly analytics will appear here</p>
                    <p style="color: #7f8c8d;">Track your productivity patterns and improvements over time</p>
                </div>
            </div>
        </div>

        <!-- Check-ins Section -->
        <div id="check-ins" class="section" style="display: none;">
            <h2 class="section-title">üíå Relationship Check-ins</h2>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <h3>üéØ This Week's Goal</h3>
                    <p id="weeklyGoal" style="font-size: 1.1rem; line-height: 1.6; color: #2c3e50;">Loading your relationship insights...</p>
                    
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="loadCheckIns()">üîÑ Refresh Check-ins</button>
                    </div>
                </div>

                <div class="feature-card">
                    <h3>üë• Priority Check-ins</h3>
                    
                    <!-- Configuration Panel -->
                    <div id="configPanel" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;">
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin: 0; color: #2c3e50; font-size: 16px;">üéØ Analysis Settings</h4>
                            <button id="toggleConfig" class="btn" style="font-size: 12px; padding: 4px 8px; margin-left: auto;" onclick="toggleConfigPanel()">‚öôÔ∏è Configure</button>
                        </div>
                        
                        <!-- Quick Presets -->
                        <div id="presetButtons" style="margin-bottom: 15px;">
                            <div style="margin-bottom: 8px; font-size: 14px; color: #7f8c8d;">Quick Presets:</div>
                            <div id="presetContainer" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                <button class="preset-btn" onclick="loadPreset('recent-activity')" style="background: #FF6B6B; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üî• Recent</button>
                                <button class="preset-btn" onclick="loadPreset('catch-up-mode')" style="background: #4ECDC4; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üìû Catch-Up</button>
                                <button class="preset-btn" onclick="loadPreset('reconnect-deep')" style="background: #45B7D1; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üåä Deep</button>
                                <button class="preset-btn" onclick="loadPreset('high-frequency')" style="background: #96CEB4; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">‚ö° High Freq</button>
                                <button class="preset-btn" onclick="loadPreset('random-surprise')" style="background: #FECA57; color: white; border: none; padding: 6px 12px; border-radius: 16px; font-size: 12px; cursor: pointer;">üé≤ Random</button>
                            </div>
                        </div>
                        
                        <!-- Detailed Controls -->
                        <div id="detailedControls" style="display: none; grid: auto / 1fr 1fr; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #ddd;">
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Days Since Last Contact:</label>
                                <select id="daysThreshold" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="1">1+ days (Very Recent)</option>
                                    <option value="7">7+ days (This Week)</option>
                                    <option value="14">14+ days (Two Weeks)</option>
                                    <option value="30" selected>30+ days (This Month)</option>
                                    <option value="60">60+ days (Two Months)</option>
                                    <option value="90">90+ days (Three Months)</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Lookback Period:</label>
                                <select id="lookbackDays" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="30">Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="180">Last 6 Months</option>
                                    <option value="365" selected>Last Year</option>
                                    <option value="730">Last 2 Years</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Sort By:</label>
                                <select id="sortBy" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="daysSince" selected>Days Since Contact</option>
                                    <option value="messageCount">Message Frequency</option>
                                    <option value="random">Random Order</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px;">Contact Type:</label>
                                <select id="filterType" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                    <option value="all" selected>All Contacts</option>
                                    <option value="resolved">Named Contacts Only</option>
                                    <option value="unresolved">Phone Numbers Only</option>
                                </select>
                            </div>
                            
                            <div style="grid-column: span 2;">
                                <button onclick="applyCustomConfig()" class="btn" style="width: 100%; background: #3498db; color: white; margin-top: 10px;">üîç Apply Custom Settings</button>
                            </div>
                        </div>
                        
                        <div id="currentConfig" style="margin-top: 10px; font-size: 12px; color: #7f8c8d; font-style: italic;"></div>
                    </div>
                    
                    <div id="contactsStats" style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                        <span id="contactsCount" style="font-weight: bold; color: #2c3e50;"></span>
                        <span id="contactsInsight" style="color: #7f8c8d; margin-left: 10px;"></span>
                    </div>
                    <div id="priorityContacts" style="max-height: 400px; overflow-y: auto; padding-right: 5px;">
                        <div style="text-align: center; color: #7f8c8d; padding: 20px;">
                            <p>Analyzing your message history...</p>
                            <p>Finding friends you should reconnect with</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="feature-card" style="margin-top: 20px;">
                <h3>üì± Quick Actions</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <button class="btn" style="background: #27ae60; color: white;" onclick="openMessages()">
                        üì± Open Messages App
                    </button>
                    <button class="btn" style="background: #3498db; color: white;" onclick="scheduleReminder()">
                        ‚è∞ Set Weekly Reminder
                    </button>
                    <button class="btn" style="background: #9b59b6; color: white;" onclick="exportContacts()">
                        üìã Export Contact List
                    </button>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin-bottom: 10px;">üí° Pro Tips:</h4>
                    <ul style="margin-left: 20px; line-height: 1.6;">
                        <li>Check in with close friends every 2-3 weeks</li>
                        <li>Send genuine, personal messages rather than generic "how are you?"</li>
                        <li>Reference shared memories or ask about specific things</li>
                        <li>Set a weekly goal to reach out to 2-3 people</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Schedule Preview Modal -->
    <div id="schedule-modal" class="schedule-modal">
        <div class="schedule-modal-content">
            <div id="schedule-loading" class="loading-schedule" style="display: none;">
                <div class="spinner"></div>
                <p>ü§ñ AI is analyzing your tasks and creating the optimal schedule...</p>
            </div>
            
            <div id="schedule-preview" style="display: none;">
                <div class="schedule-header">
                    <h2>üóìÔ∏è Your Optimized Task Schedule</h2>
                    <p style="color: #7f8c8d;">AI has created the perfect calendar layout for your productivity</p>
                </div>

                <div class="schedule-summary" id="schedule-summary-content">
                    <!-- Summary will be inserted here -->
                </div>

                <div class="schedule-regenerate">
                    <p style="color: #7f8c8d; margin: 0 0 10px 0;">Not happy with the schedule? Make adjustments or regenerate:</p>
                    <button class="regenerate-btn" onclick="regenerateSchedule()">üîÑ Generate New Schedule</button>
                    <button class="regenerate-btn" onclick="regenerateScheduleWithConstraints()">‚öôÔ∏è Regenerate with Preferences</button>
                </div>

                <div class="schedule-timeline" id="schedule-timeline">
                    <!-- Schedule items will be inserted here -->
                </div>

                <div class="schedule-tips" id="schedule-tips" style="display: none;">
                    <h4>üí° AI Productivity Tips</h4>
                    <ul id="schedule-tips-list">
                        <!-- Tips will be inserted here -->
                    </ul>
                </div>

                <div class="schedule-actions">
                    <button class="schedule-confirm-btn" onclick="confirmSchedule()">
                        ‚úÖ Schedule All Tasks
                    </button>
                    <button class="schedule-cancel-btn" onclick="closeScheduleModal()">
                        ‚ùå Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/utils.js"></script>
    <script src="assets/api.js"></script>
    <script>
        // Global state
        let currentSection = 'dashboard';
        let timerInterval = null;
        let timeRemaining = 25 * 60; // 25 minutes in seconds
        let isRunning = false;
        let completedSessions = 0;
        let totalFocusTime = 0;
        let currentCycle = 'work'; // 'work' or 'break'
        let cycleCount = 0;

        // Task storage
        let tasks = {
            big: [],
            medium: [],
            small: []
        };

        // Navigation
        function showSection(section) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            
            // Show selected section
            document.getElementById(section).style.display = 'block';
            
            // Update active nav
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            event.target.closest('.nav-item').classList.add('active');
            
            currentSection = section;
            
            // Auto-load data for specific sections
            if (section === 'check-ins') {
                loadCheckIns();
            } else if (section === 'email-relationships') {
                loadRelationshipStatus();
            }

            // Show/hide email chat FAB based on section
            const emailChatFab = document.querySelector('.email-chat-fab');
            const emailChatContainer = document.getElementById('ai-email-chat');

            if (section === 'emails') {
                // Show FAB when in emails section
                if (emailChatFab) {
                    emailChatFab.style.display = 'block';
                }
            } else {
                // Hide FAB and close chat when not in emails section
                if (emailChatFab) {
                    emailChatFab.style.display = 'none';
                }
                if (emailChatContainer) {
                    emailChatContainer.style.display = 'none';
                    emailChatVisible = false; // Reset chat state
                }
            }
        }

        // Pomodoro Timer Functions
        function startTimer() {
            if (currentCycle === 'work') {
                const intent = document.getElementById('sessionIntent').value;
                if (!intent.trim()) {
                    alert('Please enter your focus intention first!');
                    return;
                }
                cycleCount++;
                document.getElementById('timerStatus').textContent = `Work Session #${cycleCount}: ${intent}`;
            } else {
                document.getElementById('timerStatus').textContent = `Break time! Cycle #${cycleCount}`;
            }

            isRunning = true;
            document.getElementById('startBtn').style.display = 'none';
            document.getElementById('pauseBtn').style.display = 'inline-block';

            timerInterval = setInterval(() => {
                timeRemaining--;
                updateTimerDisplay();

                if (timeRemaining <= 0) {
                    completeSession();
                }
            }, 1000);
        }

        function pauseTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = 'Paused';
        }

        function resetTimer() {
            isRunning = false;
            clearInterval(timerInterval);
            currentCycle = 'work';
            cycleCount = 0;
            const duration = parseInt(document.getElementById('sessionDuration').value);
            timeRemaining = duration * 60;
            updateTimerDisplay();
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('pauseBtn').style.display = 'none';
            document.getElementById('timerStatus').textContent = 'Ready to focus';
            document.getElementById('sessionIntent').value = '';
        }

        // Sound notification function (moved to utils.js)

        function completeSession() {
            clearInterval(timerInterval);
            isRunning = false;
            
            // Play notification sound
            playNotificationSound();
            
            if (currentCycle === 'work') {
                // Work session completed, start break
                cycleCount++;
                currentCycle = 'break';
                const breakMinutes = parseInt(document.getElementById('breakDuration').value);
                timeRemaining = breakMinutes * 60;
                
                // Update stats only for work sessions
                completedSessions++;
                const sessionMinutes = parseInt(document.getElementById('sessionDuration').value);
                totalFocusTime += sessionMinutes;
                
                // Update display
                document.getElementById('completedSessions').textContent = completedSessions;
                document.getElementById('focusTime').textContent = totalFocusTime;
                
                // Show break notification and start break automatically
                alert(`üéâ Work session completed! Starting ${breakMinutes}-minute break.`);
                document.getElementById('timerStatus').textContent = `Break time! Cycle #${cycleCount}`;
                updateTimerDisplay();
                
                // Auto-start break timer
                isRunning = true;
                document.getElementById('startBtn').style.display = 'none';
                document.getElementById('pauseBtn').style.display = 'inline-block';
                
                timerInterval = setInterval(() => {
                    timeRemaining--;
                    updateTimerDisplay();
                    
                    if (timeRemaining <= 0) {
                        completeSession();
                    }
                }, 1000);
                
            } else {
                // Break completed, offer to continue or end
                currentCycle = 'work';
                const sessionMinutes = parseInt(document.getElementById('sessionDuration').value);
                timeRemaining = sessionMinutes * 60;
                
                const continueWork = confirm('‚òï Break complete! Ready to start another work session?');
                
                if (continueWork) {
                    // Start new work session
                    document.getElementById('timerStatus').textContent = `Ready for work session #${cycleCount + 1}`;
                    updateTimerDisplay();
                    document.getElementById('startBtn').style.display = 'inline-block';
                    document.getElementById('pauseBtn').style.display = 'none';
                } else {
                    // End the session completely
                    resetTimer();
                    alert('üèÅ Pomodoro session ended. Great work today!');
                }
            }
        }

        // Timer display function (moved to utils.js)

        function updateDuration() {
            if (!isRunning) {
                const duration = parseInt(document.getElementById('sessionDuration').value);
                document.getElementById('sessionDurationLabel').textContent = `${duration} minutes`;
                timeRemaining = duration * 60;
                updateTimerDisplay();
            }
        }

        // Task Management Functions
        function addTask(type) {
            const input = document.getElementById(`${type}TaskInput`);
            const durationSelect = document.getElementById(`${type}TaskDuration`);
            const text = input.value.trim();
            const duration = parseInt(durationSelect.value);
            
            if (!text) return;

            // Check limits
            const limits = { big: 1, medium: 3, small: 5 };
            if (tasks[type].length >= limits[type]) {
                alert(`You can only have ${limits[type]} ${type} task(s)`);
                return;
            }

            const task = {
                id: Date.now(),
                text: text,
                duration: duration,
                completed: false,
                createdAt: new Date().toISOString()
            };

            tasks[type].push(task);
            input.value = '';
            renderTasks();
            updateProgress();
        }

        function deleteTask(type, id) {
            tasks[type] = tasks[type].filter(task => task.id !== id);
            renderTasks();
            updateProgress();
        }

        function toggleTask(type, id) {
            const task = tasks[type].find(task => task.id === id);
            if (task) {
                task.completed = !task.completed;
                renderTasks();
                updateProgress();
                updateCompletedTasks();
            }
        }

        function renderTasks() {
            ['big', 'medium', 'small'].forEach(type => {
                const container = document.getElementById(`${type}Tasks`);
                container.innerHTML = '';

                tasks[type].forEach(task => {
                    const li = document.createElement('li');
                    li.className = `task-item ${type}`;
                    
                    // Format duration display
                    const duration = task.duration || 0;
                    let durationText = '';
                    if (duration >= 60) {
                        const hours = Math.floor(duration / 60);
                        const mins = duration % 60;
                        durationText = mins > 0 ? `${hours}h ${mins}m` : `${hours}h`;
                    } else {
                        durationText = `${duration}m`;
                    }
                    
                    li.innerHTML = `
                        <input type="checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="toggleTask('${type}', ${task.id})" style="margin-right: 10px;">
                        <span class="task-text" style="${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">${task.text}</span>
                        <span class="task-duration" style="color: #7f8c8d; font-size: 0.85em; margin-left: 10px;">${durationText}</span>
                        <button class="task-delete" onclick="deleteTask('${type}', ${task.id})">√ó</button>
                    `;
                    container.appendChild(li);
                });
            });
        }

        function updateProgress() {
            const limits = { big: 1, medium: 3, small: 5 };
            let totalCompleted = 0;
            let totalTasks = 0;

            ['big', 'medium', 'small'].forEach(type => {
                const completed = tasks[type].filter(task => task.completed).length;
                const total = tasks[type].length;
                const percentage = total > 0 ? (completed / total) * 100 : 0;

                document.getElementById(`${type}Progress`).textContent = `${completed}/${total}`;
                document.getElementById(`${type}ProgressBar`).style.width = `${percentage}%`;

                totalCompleted += completed;
                totalTasks += total;
            });

            const overallPercentage = totalTasks > 0 ? Math.round((totalCompleted / totalTasks) * 100) : 0;
            document.getElementById('overallProgress').textContent = `${overallPercentage}%`;
        }

        function updateCompletedTasks() {
            const completed = Object.values(tasks).flat().filter(task => task.completed).length;
            document.getElementById('tasksCompleted').textContent = completed;
        }

        // Check-in Functions
        // Global configuration state
        let currentConfig = {
            daysThreshold: 30,
            lookbackDays: 365,
            maxContacts: 15,
            sortBy: 'daysSince',
            filterType: 'all',
            minMessages: 2
        };


        async function sendMessage(contactName, rawContact, isResolved) {
            try {
                console.log(`üì± Opening Messages for: ${contactName} (${rawContact})`);
                
                const response = await fetch('/api/open-messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        contact: contactName,
                        rawContact: rawContact,
                        name: contactName,
                        isResolved: isResolved === 'true'
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show detailed success message
                    const button = event.target;
                    const originalText = button.textContent;
                    
                    // Update button with success state
                    button.textContent = '‚úì Opened!';
                    button.style.background = '#27ae60';
                    
                    // Show detailed feedback
                    console.log(`‚úÖ Messages opened successfully:`, result);
                    
                    // Create floating success message
                    const successMsg = document.createElement('div');
                    successMsg.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #27ae60;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        z-index: 1000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                        max-width: 300px;
                        font-size: 14px;
                    `;
                    
                    const methodText = {
                        'applescript': 'üçé via AppleScript',
                        'sms_url': 'üîó via SMS URL',
                        'app_only': 'üì± opened Messages app'
                    };
                    
                    successMsg.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 5px;">üíå Messages Opened!</div>
                        <div style="font-size: 12px; opacity: 0.9;">
                            Contact: ${contactName}<br>
                            Method: ${methodText[result.method] || result.method}<br>
                            ${result.target ? `Target: ${result.target}` : ''}
                        </div>
                    `;
                    
                    document.body.appendChild(successMsg);
                    
                    // Auto-remove success message
                    setTimeout(() => {
                        if (successMsg.parentNode) {
                            successMsg.parentNode.removeChild(successMsg);
                        }
                    }, 4000);
                    
                    // Reset button
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.style.background = '#27ae60';
                    }, 2000);
                    
                } else {
                    console.error('‚ùå Failed to open Messages:', result);
                    alert(`Could not open Messages app for ${contactName}. Please try manually.\n\nError: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error opening Messages:', error);
                alert('Error opening Messages app. Please try manually.');
            }
        }

        async function getSmartMessage(contactName, rawContact, isResolved) {
            try {
                console.log(`ü§ñ Getting smart message for: ${contactName} (${rawContact})`);
                
                // Show loading state
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = 'ü§ñ Analyzing...';
                button.disabled = true;
                
                const response = await fetch('/api/smart-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phoneNumber: rawContact,
                        contactName: contactName,
                        daysBack: 30,
                        birthdayContact: event.target.closest('.contact-item').querySelector('[style*="BIRTHDAY"]') !== null,
                        specialOccasion: event.target.closest('.contact-item').querySelector('[style*="BIRTHDAY"]') ? 'birthday' : null
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Create modal to show smart message suggestions
                    const modal = document.createElement('div');
                    modal.style.cssText = `
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        background: rgba(0,0,0,0.7);
                        z-index: 10000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    
                    const modalContent = document.createElement('div');
                    modalContent.style.cssText = `
                        background: white;
                        border-radius: 12px;
                        padding: 30px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                    `;
                    
                    const analysis = result.analysis;
                    modalContent.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                            <h2 style="margin: 0; color: #9b59b6;">ü§ñ Smart Message for ${contactName}</h2>
                            <button onclick="this.closest('.modal').remove(); event.stopPropagation();" style="background: none; border: none; font-size: 24px; cursor: pointer; margin-left: auto;">√ó</button>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; color: #666;">üìä Relationship Context</h4>
                            ${analysis.relationship ? `
                                <p style="margin: 5px 0;"><strong>Known each other:</strong> ${analysis.relationship.years_known} years</p>
                                <p style="margin: 5px 0;"><strong>Total messages:</strong> ${analysis.relationship.total_messages}</p>
                                <p style="margin: 5px 0;"><strong>Last contact:</strong> ${analysis.relationship.days_since_last} days ago</p>
                                <p style="margin: 5px 0;"><strong>Balance:</strong> ${analysis.relationship.conversation_balance}</p>
                                <p style="margin: 5px 0;"><strong>Relationship type:</strong> ${analysis.relationshipType || analysis.relationship.analysis_type}</p>
                            ` : `
                                <p style="margin: 5px 0;"><strong>Messages Found:</strong> ${analysis.messageCount || 0} messages</p>
                                <p style="margin: 5px 0;"><strong>Balance:</strong> ${analysis.conversationBalance || 'No data'}</p>
                            `}
                            <p style="margin: 5px 0;"><strong>Topics:</strong> ${analysis.topics || 'General conversation'}</p>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h4 style="margin: 0 0 15px 0; color: #333;">üí¨ Suggested Messages</h4>
                            ${analysis.suggestions.map((suggestion, index) => `
                                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; border: 2px solid transparent;" 
                                     onclick="copyToClipboard('${suggestion.replace(/'/g, "\\'")}', this)" 
                                     onmouseover="this.style.borderColor='#27ae60'" 
                                     onmouseout="this.style.borderColor='transparent'">
                                    <div style="font-weight: 500; margin-bottom: 5px;">Option ${index + 1}</div>
                                    <div>"${suggestion}"</div>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 8px;">Click to copy</div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; padding-top: 15px; border-top: 1px solid #eee;">
                            <button onclick="sendMessage('${contactName}', '${rawContact}', '${isResolved}'); this.closest('.modal').remove();" 
                                    style="background: #27ae60; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-right: 10px;">
                                üíå Open Messages
                            </button>
                            <button onclick="this.closest('.modal').remove();" 
                                    style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                                Close
                            </button>
                        </div>
                    `;
                    
                    modal.appendChild(modalContent);
                    modal.className = 'modal';
                    document.body.appendChild(modal);
                    
                    // Close modal when clicking outside
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            modal.remove();
                        }
                    });
                    
                } else {
                    console.error('‚ùå Failed to get smart message:', result);
                    alert(`Could not analyze conversation for ${contactName}.\n\nError: ${result.error || 'Unknown error'}`);
                }
                
                // Reset button
                button.textContent = originalText;
                button.disabled = false;
                
            } catch (error) {
                console.error('Error getting smart message:', error);
                alert('Error analyzing conversation. Please try manually.');
                
                // Reset button
                const button = event.target;
                button.textContent = 'ü§ñ Smart Message';
                button.disabled = false;
            }
        }

        // Helper function to copy text to clipboard
        // Clipboard utility function (moved to utils.js)

        async function openMessages() {
            try {
                const response = await fetch('/api/open-messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ contact: '' }) // Empty contact = just open Messages
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    alert('Could not open Messages app');
                }
            } catch (error) {
                console.error('Error opening Messages:', error);
                alert('Error opening Messages app');
            }
        }

        function scheduleReminder() {
            // Set a weekly reminder using macOS notifications
            alert('‚è∞ Weekly relationship check-in reminder set!\n\nYou\'ll get notified every Monday at 9 AM to review your relationships.');
            
            // In a real implementation, you'd use:
            // - macOS Calendar app to create recurring event
            // - LaunchAgent for system-level notifications
            // - or Electron's notification API
        }

        function exportContacts() {
            // Export priority contacts as a simple list
            loadCheckIns().then(() => {
                const contacts = document.querySelectorAll('#priorityContacts .task-item');
                let exportText = "LifeOps Relationship Check-in List\n";
                exportText += "Generated: " + new Date().toLocaleDateString() + "\n\n";
                
                contacts.forEach((contact, index) => {
                    const name = contact.querySelector('div:first-child div:first-child').textContent.replace('üë§ ', '');
                    const days = contact.querySelector('div:first-child div:nth-child(2)').textContent;
                    exportText += `${index + 1}. ${name} - ${days}\n`;
                });
                
                // Create downloadable file
                const blob = new Blob([exportText], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'lifeops-checkins.txt';
                a.click();
                URL.revokeObjectURL(url);
            });
        }

        // AI Task Scheduler Functions
        let pendingSchedule = null;
        let currentScheduleData = null;
        let editingItemIndex = null;

        async function scheduleTasksWithAI() {
            // Check if there are any tasks to schedule
            const totalTasks = Object.values(tasks).flat().length;
            if (totalTasks === 0) {
                alert('Please add some tasks first before scheduling!');
                return;
            }

            // Show modal and loading state
            document.getElementById('schedule-modal').style.display = 'flex';
            document.getElementById('schedule-loading').style.display = 'block';
            document.getElementById('schedule-preview').style.display = 'none';
            
            try {
                const response = await fetch('/api/ai-schedule-tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        tasks: tasks,
                        preferences: {
                            workingHours: '9 AM - 6 PM',
                            energyPreference: 'High energy tasks in morning, lighter tasks in afternoon'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentScheduleData = data;
                    displaySchedulePreview(data);
                    pendingSchedule = data.formatted_events;
                } else {
                    throw new Error(data.message || 'Failed to create schedule');
                }
                
            } catch (error) {
                console.error('Error creating schedule:', error);
                alert('Sorry, I had trouble creating your schedule. Please try again.');
                closeScheduleModal();
            } finally {
                document.getElementById('schedule-loading').style.display = 'none';
            }
        }

        function displaySchedulePreview(scheduleData) {
            document.getElementById('schedule-preview').style.display = 'block';
            
            // Update summary
            const summaryContent = document.getElementById('schedule-summary-content');
            summaryContent.innerHTML = `
                <h3 style="margin: 0 0 10px 0;">üìä Schedule Overview</h3>
                <p style="margin: 5px 0;"><strong>Total Time:</strong> ${scheduleData.total_time}</p>
                <p style="margin: 5px 0;"><strong>Events:</strong> ${scheduleData.events_count} calendar blocks</p>
                <p style="margin: 10px 0 0 0;">${scheduleData.summary}</p>
            `;
            
            // Update timeline with editing controls
            const timeline = document.getElementById('schedule-timeline');
            timeline.innerHTML = scheduleData.schedule.map((item, index) => {
                const startDate = new Date(`${item.start_date}T${item.start_time}`);
                const endDate = new Date(`${item.end_date}T${item.end_time}`);
                const timeStr = `${startDate.toLocaleDateString()} ${startDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} - ${endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
                
                return `
                    <div class="schedule-item editable ${item.task_type}" data-index="${index}" ${item.removed ? 'style="display: none;"' : ''}>
                        <div class="schedule-controls">
                            <div class="control-btn edit" onclick="editScheduleItem(${index})" title="Edit time">‚è∞</div>
                            <div class="control-btn remove" onclick="removeScheduleItem(${index})" title="Remove task">√ó</div>
                        </div>
                        <div class="schedule-time">${timeStr}</div>
                        <div class="schedule-details">
                            <div class="schedule-title">${item.title}</div>
                            <div class="schedule-task">üìã ${item.task_text}</div>
                            <div class="schedule-reasoning">üí° ${item.reasoning}</div>
                        </div>
                        <div class="energy-badge ${item.energy_level}">${item.energy_level.toUpperCase()}</div>
                        
                        <div class="time-editor" id="editor-${index}">
                            <div class="time-inputs">
                                <div class="time-input-group">
                                    <label>Start Date</label>
                                    <input type="date" id="start-date-${index}" value="${item.start_date}">
                                </div>
                                <div class="time-input-group">
                                    <label>Start Time</label>
                                    <input type="time" id="start-time-${index}" value="${item.start_time}">
                                </div>
                                <div class="time-input-group">
                                    <label>Duration</label>
                                    <select id="duration-${index}">
                                        <option value="15" ${item.duration_minutes === 15 ? 'selected' : ''}>15 min</option>
                                        <option value="30" ${item.duration_minutes === 30 ? 'selected' : ''}>30 min</option>
                                        <option value="45" ${item.duration_minutes === 45 ? 'selected' : ''}>45 min</option>
                                        <option value="60" ${item.duration_minutes === 60 ? 'selected' : ''}>1 hour</option>
                                        <option value="90" ${item.duration_minutes === 90 ? 'selected' : ''}>1.5 hours</option>
                                        <option value="120" ${item.duration_minutes === 120 ? 'selected' : ''}>2 hours</option>
                                        <option value="180" ${item.duration_minutes === 180 ? 'selected' : ''}>3 hours</option>
                                        <option value="240" ${item.duration_minutes === 240 ? 'selected' : ''}>4 hours</option>
                                    </select>
                                </div>
                            </div>
                            <div class="time-editor-actions">
                                <button class="time-save-btn" onclick="saveScheduleEdit(${index})">Save</button>
                                <button class="time-cancel-btn" onclick="cancelScheduleEdit(${index})">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Update tips
            if (scheduleData.tips && scheduleData.tips.length > 0) {
                document.getElementById('schedule-tips').style.display = 'block';
                document.getElementById('schedule-tips-list').innerHTML = 
                    scheduleData.tips.map(tip => `<li>${tip}</li>`).join('');
            }
        }

        async function confirmSchedule() {
            if (!pendingSchedule) return;
            
            try {
                const confirmBtn = document.querySelector('.schedule-confirm-btn');
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Creating Events...';
                
                const response = await fetch('/api/ai-schedule-tasks/confirm', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ events: pendingSchedule })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show success message
                    alert(`üéâ ${data.summary}\n\nYour calendar has been updated with optimized task blocks!`);
                    
                    // Close modal
                    closeScheduleModal();
                    
                    // Optionally clear completed tasks or mark them as scheduled
                    // markTasksAsScheduled();
                    
                } else {
                    throw new Error(data.message || 'Failed to create calendar events');
                }
                
            } catch (error) {
                console.error('Error confirming schedule:', error);
                alert('Sorry, there was an error creating your calendar events. Please try again.');
            } finally {
                const confirmBtn = document.querySelector('.schedule-confirm-btn');
                confirmBtn.disabled = false;
                confirmBtn.textContent = '‚úÖ Schedule All Tasks';
            }
        }

        function closeScheduleModal() {
            document.getElementById('schedule-modal').style.display = 'none';
            pendingSchedule = null;
            currentScheduleData = null;
            editingItemIndex = null;
        }

        // Schedule Editing Functions
        function editScheduleItem(index) {
            // Close any other open editors
            document.querySelectorAll('.time-editor').forEach(editor => {
                editor.classList.remove('active');
            });
            
            // Open this editor
            const editor = document.getElementById(`editor-${index}`);
            editor.classList.add('active');
            editingItemIndex = index;
        }

        function cancelScheduleEdit(index) {
            const editor = document.getElementById(`editor-${index}`);
            editor.classList.remove('active');
            editingItemIndex = null;
        }

        function saveScheduleEdit(index) {
            const startDate = document.getElementById(`start-date-${index}`).value;
            const startTime = document.getElementById(`start-time-${index}`).value;
            const duration = parseInt(document.getElementById(`duration-${index}`).value);
            
            // Update the schedule data
            const item = currentScheduleData.schedule[index];
            item.start_date = startDate;
            item.start_time = startTime;
            item.duration_minutes = duration;
            
            // Calculate new end time
            const startDateTime = new Date(`${startDate}T${startTime}`);
            const endDateTime = new Date(startDateTime.getTime() + duration * 60000);
            item.end_date = endDateTime.toISOString().split('T')[0];
            item.end_time = endDateTime.toTimeString().slice(0, 5);
            
            // Update the formatted events for calendar creation
            updateFormattedEvents();
            
            // Refresh the display
            displaySchedulePreview(currentScheduleData);
            
            // Close editor
            cancelScheduleEdit(index);
        }

        function removeScheduleItem(index) {
            if (confirm('Remove this task from the schedule?')) {
                // Mark as removed
                currentScheduleData.schedule[index].removed = true;
                
                // Update formatted events
                updateFormattedEvents();
                
                // Update the display
                const item = document.querySelector(`[data-index="${index}"]`);
                item.classList.add('removed-item');
                item.style.display = 'none';
                
                // Update summary
                updateScheduleSummary();
            }
        }

        function updateFormattedEvents() {
            // Regenerate formatted events from current schedule data
            pendingSchedule = currentScheduleData.schedule
                .filter(item => !item.removed)
                .map(item => ({
                    summary: item.title,
                    description: `üìã Task: ${item.task_text}\n\nüß† Energy Level: ${item.energy_level}\nüí° Reasoning: ${item.reasoning}`,
                    start: new Date(`${item.start_date}T${item.start_time}`).toISOString(),
                    end: new Date(`${item.end_date}T${item.end_time}`).toISOString(),
                    colorId: item.task_type === 'big' ? '11' : item.task_type === 'medium' ? '9' : '2',
                    extendedProperties: {
                        private: {
                            lifeops_task_id: item.task_id,
                            lifeops_task_type: item.task_type,
                            lifeops_energy_level: item.energy_level
                        }
                    }
                }));
        }

        function updateScheduleSummary() {
            const activeItems = currentScheduleData.schedule.filter(item => !item.removed);
            const totalMinutes = activeItems.reduce((sum, item) => sum + item.duration_minutes, 0);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            const totalTime = hours > 0 ? `${hours} hours ${minutes} minutes` : `${minutes} minutes`;
            
            currentScheduleData.total_time = totalTime;
            currentScheduleData.events_count = activeItems.length;
            
            // Update summary display
            const summaryContent = document.getElementById('schedule-summary-content');
            summaryContent.innerHTML = `
                <h3 style="margin: 0 0 10px 0;">üìä Schedule Overview</h3>
                <p style="margin: 5px 0;"><strong>Total Time:</strong> ${totalTime}</p>
                <p style="margin: 5px 0;"><strong>Events:</strong> ${activeItems.length} calendar blocks</p>
                <p style="margin: 10px 0 0 0;">${currentScheduleData.summary}</p>
            `;
        }

        async function regenerateSchedule() {
            // Just call the original scheduling function again
            document.getElementById('schedule-loading').style.display = 'block';
            document.getElementById('schedule-preview').style.display = 'none';
            
            try {
                const response = await fetch('/api/ai-schedule-tasks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        tasks: tasks,
                        preferences: {
                            workingHours: '9 AM - 6 PM',
                            energyPreference: 'High energy tasks in morning, lighter tasks in afternoon'
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentScheduleData = data;
                    displaySchedulePreview(data);
                    pendingSchedule = data.formatted_events;
                }
                
            } catch (error) {
                console.error('Error regenerating schedule:', error);
                alert('Sorry, I had trouble regenerating your schedule.');
            } finally {
                document.getElementById('schedule-loading').style.display = 'none';
            }
        }

        async function regenerateScheduleWithConstraints() {
            // This could open a preferences dialog in the future
            const workingHours = prompt('Preferred working hours (e.g., "8 AM - 5 PM"):', '9 AM - 6 PM');
            const energyPreference = prompt('Energy preference:', 'High energy tasks in morning, lighter tasks in afternoon');
            
            if (workingHours) {
                document.getElementById('schedule-loading').style.display = 'block';
                document.getElementById('schedule-preview').style.display = 'none';
                
                try {
                    const response = await fetch('/api/ai-schedule-tasks', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            tasks: tasks,
                            preferences: {
                                workingHours: workingHours,
                                energyPreference: energyPreference
                            }
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        currentScheduleData = data;
                        displaySchedulePreview(data);
                        pendingSchedule = data.formatted_events;
                    }
                    
                } catch (error) {
                    console.error('Error regenerating schedule:', error);
                    alert('Sorry, I had trouble regenerating your schedule.');
                } finally {
                    document.getElementById('schedule-loading').style.display = 'none';
                }
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('schedule-modal');
            if (event.target === modal) {
                closeScheduleModal();
            }
        });

        // Email Analysis Functions

        function displayEmails(emails) {
            const emailGrid = document.getElementById('email-grid');
            
            emails.forEach(email => {
                const card = document.createElement('div');
                card.className = 'email-card';
                
                card.innerHTML = `
                    <div class="email-header">
                        <div class="email-subject">${email.subject}</div>
                        <div class="email-from">From: ${email.from}</div>
                    </div>
                    
                    <div class="email-summary">
                        <strong>ü§ñ AI Summary:</strong><br>
                        ${email.summary}
                    </div>
                    
                    <div>
                        <span class="priority ${email.urgency ? email.urgency.toLowerCase() : 'medium'}">
                            ‚ö° ${email.urgency || 'Medium'} Priority
                        </span>
                    </div>
                    
                    <div class="category-badge ${email.category ? email.category.toLowerCase() : 'other'}">
                        üìÇ ${email.category || 'Other'}
                    </div>
                    
                    <div class="action-needed ${email.requiresResponse ? 'yes' : 'no'}">
                        üéØ Response Needed: ${email.requiresResponse ? 'Yes' : 'No'}
                    </div>
                    
                    ${email.keyPoints && email.keyPoints.length > 0 ? `
                        <div class="key-points">
                            <h4>üîë Key Points:</h4>
                            <ul>
                                ${email.keyPoints.map(point => `<li>${point}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${email.actionItems && email.actionItems.length > 0 ? `
                        <div class="action-items">
                            <h4>‚úÖ Action Items:</h4>
                            <ul>
                                ${email.actionItems.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    
                    ${email.suggestedResponse ? `
                        <div class="suggested-response">
                            <h4>üí¨ Suggested Response:</h4>
                            <p>${email.suggestedResponse}</p>
                        </div>
                    ` : ''}
                `;
                
                emailGrid.appendChild(card);
            });
        }

        // Email AI Chat Functions
        let emailChatVisible = false;
        let conversationHistory = [];

        function toggleEmailChat() {
            const chatContainer = document.getElementById('ai-email-chat');
            const chatFab = document.querySelector('.email-chat-fab');
            
            emailChatVisible = !emailChatVisible;
            
            if (emailChatVisible) {
                chatContainer.style.display = 'flex';
                chatFab.style.display = 'none';
                document.getElementById('email-chat-input').focus();
            } else {
                chatContainer.style.display = 'none';
                chatFab.style.display = 'block';
            }
        }

        function handleEmailChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendEmailChatMessage();
            }
        }

        async function sendEmailChatMessage() {
            const input = document.getElementById('email-chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Clear input and add user message
            input.value = '';
            addEmailMessage('user', message);
            
            // Add to conversation history
            conversationHistory.push({ role: 'user', content: message });
            
            // Show typing indicator
            showEmailTypingIndicator();
            
            try {
                const response = await fetch('/api/ai-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        message: message,
                        conversationHistory: conversationHistory 
                    })
                });
                
                const data = await response.json();
                hideEmailTypingIndicator();
                
                // Add to conversation history
                conversationHistory.push({ role: 'assistant', content: data.response });
                
                // Add AI response
                addEmailMessage('ai', data.response);
                
                // Handle different actions
                if (data.action === 'draft' && data.email_details) {
                    showEmailDraftConfirmation(data.email_details);
                } else if (data.action === 'confirm') {
                    // This could trigger actual email sending
                    addEmailMessage('ai', 'Email functionality ready for implementation!');
                } else if (data.serviceStatus && !data.serviceStatus.serviceReady) {
                    addEmailMessage('ai', 'Please ensure OpenAI API key and Gmail authentication are properly configured.');
                }
                
            } catch (error) {
                console.error('Email chat error:', error);
                hideEmailTypingIndicator();
                addEmailMessage('ai', "I'm having trouble processing your request. Please try again.");
            }
        }

        function addEmailMessage(sender, content) {
            const messagesContainer = document.getElementById('email-chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = sender === 'user' ? 'üë§' : 'üìß';
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showEmailDraftConfirmation(emailDetails) {
            const confirmationDiv = document.createElement('div');
            confirmationDiv.className = 'email-draft-confirmation';
            confirmationDiv.innerHTML = `
                <div class="draft-preview">
                    <h4>üìù Email Draft Preview</h4>
                    <div class="draft-details">
                        <p><strong>To:</strong> ${emailDetails.recipient || 'Not specified'}</p>
                        <p><strong>Subject:</strong> ${emailDetails.subject || 'No subject'}</p>
                        <div class="draft-body">
                            <strong>Body:</strong>
                            <div class="body-preview">${emailDetails.body || 'No content'}</div>
                        </div>
                        <p><strong>Tone:</strong> ${emailDetails.tone || 'professional'}</p>
                        <p><strong>Priority:</strong> ${emailDetails.priority || 'medium'}</p>
                    </div>
                    <div class="draft-actions">
                        <button onclick="sendEmailDraft()" class="draft-btn send">Send Email</button>
                        <button onclick="editEmailDraft()" class="draft-btn edit">Edit Draft</button>
                        <button onclick="cancelEmailDraft()" class="draft-btn cancel">Cancel</button>
                    </div>
                </div>
            `;
            
            const messagesContainer = document.getElementById('email-chat-messages');
            messagesContainer.appendChild(confirmationDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function sendEmailDraft() {
            addEmailMessage('ai', 'Email sending functionality will be implemented soon! Your draft looks great.');
        }

        function editEmailDraft() {
            addEmailMessage('ai', 'What changes would you like me to make to the email?');
        }

        function cancelEmailDraft() {
            addEmailMessage('ai', 'Draft cancelled. How else can I help with your emails?');
        }

        function showEmailTypingIndicator() {
            document.getElementById('email-typing-indicator').style.display = 'flex';
            const messagesContainer = document.getElementById('email-chat-messages');
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideEmailTypingIndicator() {
            document.getElementById('email-typing-indicator').style.display = 'none';
        }

        // Email Relationship Intelligence Functions

        async function startRelationshipAnalysis() {
            const btn = document.getElementById('analysisBtn');
            const statusContent = document.getElementById('status-content');
            
            try {
                btn.disabled = true;
                btn.textContent = 'üöÄ Starting...';
                
                statusContent.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <div>Starting analysis of your sent emails...</div>
                    </div>
                `;
                
                const response = await fetch('/api/email-relationships/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ yearsBack: 5 })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    statusContent.innerHTML = `
                        <div>
                            <strong>‚úÖ Analysis Started!</strong><br>
                            Processing ${result.yearsBack} years of sent emails. This should be much faster!
                        </div>
                    `;
                    
                    btn.textContent = '‚è≥ Processing...';
                    
                    // Poll for status updates
                    pollRelationshipStatus();
                } else {
                    throw new Error(result.message || 'Failed to start analysis');
                }
            } catch (error) {
                console.error('Error starting relationship analysis:', error);
                statusContent.innerHTML = `
                    <div style="color: #ff6b6b;">
                        ‚ùå Error: ${error.message}
                    </div>
                `;
                btn.disabled = false;
                btn.textContent = 'üöÄ Analyze Sent Emails (5 Years)';
            }
        }

        function pollRelationshipStatus() {
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch('/api/email-relationships/status');
                    const status = await response.json();
                    
                    if (status.processing && status.processing.status === 'completed') {
                        clearInterval(pollInterval);
                        loadRelationshipStatus();
                    } else if (status.processing && status.processing.status === 'running') {
                        const statusContent = document.getElementById('status-content');
                        const proc = status.processing;
                        statusContent.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 20px; height: 20px; border: 2px solid #fff; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                                <div>
                                    <strong>Analysis in Progress</strong><br>
                                    üìß Processed: ${proc.emails_processed || 0} emails<br>
                                    ‚è±Ô∏è Running for: ${Math.round((new Date() - new Date(proc.start_date)) / 60000)} minutes<br>
                                    <span style="color: #27ae60; font-size: 0.9rem;">üí° Results updating in real-time below</span>
                                </div>
                            </div>
                        `;
                        
                        // Update results every few polling cycles (every 15 seconds)
                        if (Math.random() < 0.3) { // 30% chance each poll = ~every 15 seconds
                            loadDormantRelationships();
                            loadRelationshipInsights();
                        }
                    }
                } catch (error) {
                    console.error('Error polling status:', error);
                    clearInterval(pollInterval);
                }
            }, 5000); // Poll every 5 seconds
        }



        async function suggestMessage(emailAddress) {
            try {
                // Find the relationship card for this email
                const relationshipCards = document.querySelectorAll('[id^="relationship-card-"]');
                let targetCard = null;
                
                relationshipCards.forEach(card => {
                    if (card.innerHTML.includes(emailAddress)) {
                        targetCard = card;
                    }
                });
                
                if (!targetCard) {
                    // Fallback: find by email in any element
                    const allCards = document.querySelectorAll('.dormant-relationships > div');
                    allCards.forEach(card => {
                        if (card.innerHTML.includes(emailAddress)) {
                            targetCard = card;
                        }
                    });
                }
                
                // Show loading state inline
                const suggestBtn = event.target;
                const originalText = suggestBtn.textContent;
                suggestBtn.disabled = true;
                suggestBtn.innerHTML = '‚è≥ Generating...';
                
                // Add loading container after the button
                const loadingDiv = document.createElement('div');
                loadingDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #3498db;';
                loadingDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px; color: #2c3e50;">
                        <div style="width: 16px; height: 16px; border: 2px solid #3498db; border-top: 2px solid transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <span>ü§ñ Analyzing conversation history and generating personalized message...</span>
                    </div>
                `;
                suggestBtn.parentNode.appendChild(loadingDiv);
                
                const response = await fetch('/api/email-relationships/suggest-message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ emailAddress })
                });
                
                const result = await response.json();
                
                // Remove loading div
                loadingDiv.remove();
                
                if (result.success && result.suggestion) {
                    const suggestion = result.suggestion;
                    
                    // Create inline suggestion display
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.style.cssText = 'margin-top: 15px; padding: 20px; background: #e8f5e8; border-radius: 8px; border-left: 4px solid #27ae60;';
                    suggestionDiv.innerHTML = `
                        <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: #27ae60;">ü§ñ AI-Generated Reconnection Email</h4>
                            <button onclick="this.parentNode.parentNode.remove()" style="background: none; border: none; font-size: 18px; cursor: pointer; color: #7f8c8d;">√ó</button>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <strong>Subject:</strong> ${suggestion.subject}<br>
                            <small style="color: #7f8c8d;">Context: ${suggestion.context.daysSinceLastContact} days since last contact ‚Ä¢ ${suggestion.context.totalEmailsSent} emails sent historically</small>
                        </div>
                        
                        <div style="background: white; padding: 15px; border-radius: 6px; white-space: pre-line; line-height: 1.5; margin-bottom: 15px;">
${suggestion.body}
                        </div>
                        
                        <div style="display: flex; gap: 10px;">
                            <button onclick="copyToClipboard(\`${suggestion.subject}\`, \`${suggestion.body.replace(/`/g, '\\`')}\`)" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                üìã Copy Email
                            </button>
                            <button onclick="openEmailClient('${emailAddress}', \`${suggestion.subject}\`, \`${suggestion.body.replace(/`/g, '\\`')}\`)" style="background: #27ae60; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                üìß Open in Email Client
                            </button>
                        </div>
                    `;
                    
                    suggestBtn.parentNode.appendChild(suggestionDiv);
                    
                    // Reset button
                    suggestBtn.disabled = false;
                    suggestBtn.innerHTML = '‚úÖ Generated';
                    suggestBtn.style.background = '#27ae60';
                    
                    // Scroll suggestion into view
                    suggestionDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    
                } else {
                    // Reset button and show error
                    suggestBtn.disabled = false;
                    suggestBtn.textContent = originalText;
                    
                    const errorDiv = document.createElement('div');
                    errorDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #ffe6e6; border-radius: 8px; border-left: 4px solid #e74c3c; color: #c0392b;';
                    errorDiv.innerHTML = `‚ùå ${result.error || 'Unable to generate message suggestion'}`;
                    suggestBtn.parentNode.appendChild(errorDiv);
                    
                    // Auto-remove error after 5 seconds
                    setTimeout(() => errorDiv.remove(), 5000);
                }
                
            } catch (error) {
                console.error('Error getting message suggestion:', error);
                
                // Reset button and show error
                const suggestBtn = event.target;
                suggestBtn.disabled = false;
                suggestBtn.textContent = 'üí° Suggest Message';
                
                const errorDiv = document.createElement('div');
                errorDiv.style.cssText = 'margin-top: 15px; padding: 15px; background: #ffe6e6; border-radius: 8px; border-left: 4px solid #e74c3c; color: #c0392b;';
                errorDiv.innerHTML = `‚ùå Error generating suggestion. Please try again.`;
                suggestBtn.parentNode.appendChild(errorDiv);
                
                // Auto-remove error after 5 seconds
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }

        function copyToClipboard(subject, body) {
            const emailText = `Subject: ${subject}\n\n${body}`;
            navigator.clipboard.writeText(emailText).then(() => {
                // Show success feedback
                event.target.innerHTML = '‚úÖ Copied!';
                setTimeout(() => {
                    event.target.innerHTML = 'üìã Copy Email';
                }, 2000);
            });
        }

        function openEmailClient(email, subject, body) {
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateTimerDisplay();
            renderTasks();
            updateProgress();
            
            // Auto-load check-ins when section is first visited
            if (currentSection === 'check-ins') {
                loadCheckIns();
            }

            // Auto-resize email chat input
            const emailChatInput = document.getElementById('email-chat-input');
            if (emailChatInput) {
                emailChatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 80) + 'px';
                });
            }
        });

        // Configuration Management Functions
        let presets = {};


        function toggleConfigPanel() {
            const detailedControls = document.getElementById('detailedControls');
            const toggleBtn = document.getElementById('toggleConfig');
            
            if (detailedControls.style.display === 'none') {
                detailedControls.style.display = 'grid';
                toggleBtn.textContent = '‚¨ÜÔ∏è Hide';
                
                // Populate current values
                document.getElementById('daysThreshold').value = currentConfig.daysThreshold;
                document.getElementById('lookbackDays').value = currentConfig.lookbackDays;
                document.getElementById('sortBy').value = currentConfig.sortBy;
                document.getElementById('filterType').value = currentConfig.filterType;
            } else {
                detailedControls.style.display = 'none';
                toggleBtn.textContent = '‚öôÔ∏è Configure';
            }
        }

        async function loadPreset(presetKey) {
            try {
                console.log(`üìã Loading preset: ${presetKey}`);
                
                if (!presets[presetKey]) {
                    await loadPresets();
                }
                
                const preset = presets[presetKey];
                if (!preset) {
                    console.error('Preset not found:', presetKey);
                    return;
                }
                
                // Update current config
                currentConfig = { ...preset.config };
                
                // Update UI to show what's happening
                updateConfigDisplay(preset.name, preset.description);
                
                // Apply the preset
                await loadCheckIns(currentConfig);
                
                // Highlight the active preset button
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.style.opacity = '0.7';
                    btn.style.transform = 'scale(1)';
                });
                
                const activeBtn = document.querySelector(`[onclick="loadPreset('${presetKey}')"]`);
                if (activeBtn) {
                    activeBtn.style.opacity = '1';
                    activeBtn.style.transform = 'scale(1.05)';
                    activeBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.2)';
                }
                
            } catch (error) {
                console.error('Error loading preset:', error);
            }
        }

        function applyCustomConfig() {
            // Get values from form
            const newConfig = {
                daysThreshold: parseInt(document.getElementById('daysThreshold').value),
                lookbackDays: parseInt(document.getElementById('lookbackDays').value),
                maxContacts: 15, // Keep this fixed for now
                sortBy: document.getElementById('sortBy').value,
                filterType: document.getElementById('filterType').value,
                minMessages: 2 // Keep this fixed for now
            };
            
            // Update global config
            currentConfig = newConfig;
            
            // Update display
            updateConfigDisplay('Custom Configuration', getConfigDescription(newConfig));
            
            // Apply changes
            loadCheckIns(currentConfig);
            
            // Reset preset button highlights
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.style.opacity = '0.7';
                btn.style.transform = 'scale(1)';
                btn.style.boxShadow = 'none';
            });
        }

        function updateConfigDisplay(title, description) {
            const currentConfigDiv = document.getElementById('currentConfig');
            currentConfigDiv.innerHTML = `<strong>${title}:</strong> ${description}`;
        }

        // Config description formatter (moved to utils.js)

        // Load presets when page loads
        loadPresets();

        // ==========================================
        // PRODUCTIVITY ORCHESTRATOR FUNCTIONS
        // ==========================================

        // Start daily productivity orchestration
        async function startDailyOrchestration() {
            const btn = document.querySelector('.orchestrator-btn.primary');
            const originalText = btn.textContent;
            
            try {
                btn.textContent = 'üîÑ Starting...';
                btn.disabled = true;
                
                // Show status panel
                showOrchestrationStatus();
                updateOrchestrationStatus('interview', 'üîÑ Starting...');
                
                // Start the orchestration workflow with timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 300000); // 5 minute timeout
                
                const response = await fetch('/api/productivity/orchestrate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userInput: 'Start my daily productivity orchestration',
                        preferences: {
                            workStartTime: '09:00',
                            workEndTime: '17:00',
                            breakDuration: 15,
                            pomodoroLength: 25
                        }
                    }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.phase === 'interview') {
                        // Show interview questions
                        updateOrchestrationStatus('interview', 'üîÑ Active');
                        updateOrchestrationStatus('data', '‚è≥ Pending');
                        updateOrchestrationStatus('analysis', '‚è≥ Pending');
                        updateOrchestrationStatus('schedule', '‚è≥ Pending');
                        
                        showInterviewQuestions(data.interview);
                        btn.textContent = 'üó£Ô∏è Interview Active';
                    } else {
                        // Complete workflow
                        updateOrchestrationStatus('interview', '‚úÖ Complete');
                        updateOrchestrationStatus('data', '‚úÖ Complete');
                        updateOrchestrationStatus('analysis', '‚úÖ Complete');
                        updateOrchestrationStatus('schedule', '‚úÖ Complete');
                        
                        // Show success message
                        showNotification('üéâ Your perfect day is ready! Check your calendar for the optimized schedule.', 'success');
                        
                        btn.textContent = '‚úÖ Day Started';
                        setTimeout(() => {
                            btn.textContent = originalText;
                            btn.disabled = false;
                        }, 3000);
                    }
                } else {
                    throw new Error(data.message || 'Orchestration failed');
                }
                
            } catch (error) {
                console.error('Orchestration error:', error);
                
                let errorMessage = 'Failed to start orchestration';
                if (error.name === 'AbortError') {
                    errorMessage = 'Orchestration timed out (taking longer than 60s). Please try again.';
                } else if (error.message) {
                    errorMessage = error.message;
                }
                
                showNotification('‚ùå ' + errorMessage, 'error');
                
                btn.textContent = originalText;
                btn.disabled = false;
                
                updateOrchestrationStatus('interview', '‚ùå Error');
                updateOrchestrationStatus('data', '‚ùå Error');
                updateOrchestrationStatus('analysis', '‚ùå Error');
                updateOrchestrationStatus('schedule', '‚ùå Error');
            }
        }

        // Show/hide orchestration status
        function showOrchestrationStatus() {
            const statusDiv = document.getElementById('orchestration-status');
            if (statusDiv.style.display === 'none') {
                statusDiv.style.display = 'block';
                
                // Load current status
                loadOrchestrationStatus();
            } else {
                statusDiv.style.display = 'none';
            }
        }

        // Update individual status item
        function updateOrchestrationStatus(component, status) {
            const statusElement = document.getElementById(component + '-status');
            if (statusElement) {
                statusElement.textContent = status;
            }
        }

        // Show interview questions in UI
        function showInterviewQuestions(interview) {
            const schedulingSection = interview.structured_sections?.scheduling;
            const prioritiesSection = interview.structured_sections?.priorities;
            
            const interviewHTML = `
                <div class="interview-container" id="interview-container">
                    <h3>üó£Ô∏è Daily Planning Interview</h3>
                    <p class="interview-greeting">${interview.greeting}</p>

                    ${schedulingSection ? `
                        <div class="scheduling-section">
                            <h4 class="section-title">üìÖ ${schedulingSection.title}</h4>
                            <p class="section-description">${schedulingSection.description}</p>
                            
                            <div class="scheduling-controls">
                                <div class="day-selection">
                                    <label class="control-label">Which day?</label>
                                    <div class="day-options">
                                        ${schedulingSection.day_options.map(option => `
                                            <label class="day-option">
                                                <input type="radio" name="target_day" value="${option.value}" ${option.default ? 'checked' : ''}>
                                                <span class="option-label">${option.label}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                    <div class="custom-date-picker" id="custom-date-picker" style="display: none;">
                                        <input type="date" id="custom-date" class="custom-date-input">
                                    </div>
                                </div>

                                <div class="time-block-selection">
                                    <label class="control-label">What time period?</label>
                                    <div class="time-block-options">
                                        ${schedulingSection.time_block_options.map(option => `
                                            <label class="time-block-option">
                                                <input type="radio" name="time_block" value="${option.value}" ${option.default ? 'checked' : ''}>
                                                <span class="option-label">${option.label}</span>
                                            </label>
                                        `).join('')}
                                    </div>
                                    <div class="custom-time-picker" id="custom-time-picker" style="display: none;">
                                        <div class="time-range">
                                            <input type="time" id="custom-start-time" class="custom-time-input" value="09:00">
                                            <span>to</span>
                                            <input type="time" id="custom-end-time" class="custom-time-input" value="17:00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="interview-questions">
                        ${interview.questions.map((question, index) => `
                            <div class="question-group">
                                <label class="question-label">${index + 1}. ${question}</label>
                                <textarea class="question-input" id="question-${index}" placeholder="Your answer..."></textarea>
                            </div>
                        `).join('')}
                    </div>

                    ${prioritiesSection ? `
                        <div class="priorities-section">
                            <h4 class="priorities-title">üéØ ${prioritiesSection.title}</h4>
                            <p class="priorities-description">${prioritiesSection.description}</p>
                            
                            <div class="priority-task-group">
                                <div class="task-icon">üî•</div>
                                <div class="task-header">Priority 1 (Most Important)</div>
                                <div class="task-input-row">
                                    <input type="text" class="priority-task-input" id="priority-1" placeholder="${prioritiesSection.placeholder_tasks[0]}">
                                    <select class="priority-time-select" id="time-1">
                                        <option value="15min">15 min</option>
                                        <option value="30min">30 min</option>
                                        <option value="1hour" selected>1 hour</option>
                                        <option value="2hours">2 hours</option>
                                        <option value="3hours">3 hours</option>
                                        <option value="4hours">4 hours</option>
                                    </select>
                                </div>
                            </div>

                            <div class="priority-task-group">
                                <div class="task-icon">‚ö°</div>
                                <div class="task-header">Priority 2 (Important)</div>
                                <div class="task-input-row">
                                    <input type="text" class="priority-task-input" id="priority-2" placeholder="${prioritiesSection.placeholder_tasks[1]}">
                                    <select class="priority-time-select" id="time-2">
                                        <option value="15min">15 min</option>
                                        <option value="30min" selected>30 min</option>
                                        <option value="1hour">1 hour</option>
                                        <option value="2hours">2 hours</option>
                                        <option value="3hours">3 hours</option>
                                        <option value="4hours">4 hours</option>
                                    </select>
                                </div>
                            </div>

                            <div class="priority-task-group">
                                <div class="task-icon">‚úÖ</div>
                                <div class="task-header">Priority 3 (Manageable)</div>
                                <div class="task-input-row">
                                    <input type="text" class="priority-task-input" id="priority-3" placeholder="${prioritiesSection.placeholder_tasks[2]}">
                                    <select class="priority-time-select" id="time-3">
                                        <option value="15min" selected>15 min</option>
                                        <option value="30min">30 min</option>
                                        <option value="1hour">1 hour</option>
                                        <option value="2hours">2 hours</option>
                                        <option value="3hours">3 hours</option>
                                        <option value="4hours">4 hours</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="interview-actions">
                        <button class="btn primary" onclick="submitInterviewResponses()">Submit Responses</button>
                        <button class="btn secondary" onclick="hideInterview()">Skip Interview</button>
                    </div>
                </div>
            `;
            
            // Show interview in orchestration status area
            const statusDiv = document.getElementById('orchestration-status');
            statusDiv.innerHTML = interviewHTML;
            statusDiv.style.display = 'block';
            
            // Add event listeners for custom options
            setupSchedulingEventListeners();
        }

        // Setup event listeners for scheduling controls
        function setupSchedulingEventListeners() {
            // Day selection listeners
            const dayRadios = document.querySelectorAll('input[name="target_day"]');
            dayRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const customDatePicker = document.getElementById('custom-date-picker');
                    if (this.value === 'custom') {
                        customDatePicker.style.display = 'block';
                        // Set default to tomorrow
                        const tomorrow = new Date();
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        document.getElementById('custom-date').value = tomorrow.toISOString().split('T')[0];
                    } else {
                        customDatePicker.style.display = 'none';
                    }
                });
            });

            // Time block selection listeners
            const timeBlockRadios = document.querySelectorAll('input[name="time_block"]');
            timeBlockRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    const customTimePicker = document.getElementById('custom-time-picker');
                    if (this.value === 'custom') {
                        customTimePicker.style.display = 'block';
                    } else {
                        customTimePicker.style.display = 'none';
                    }
                });
            });
        }

        // Hide interview
        function hideInterview() {
            const container = document.getElementById('interview-container');
            if (container) {
                container.remove();
            }
        }

        // Submit interview responses
        async function submitInterviewResponses() {
            const responses = {};
            const questions = document.querySelectorAll('.question-input');
            
            // Collect regular question responses
            questions.forEach((input, index) => {
                responses[`question_${index}`] = input.value;
            });
            
            // Collect scheduling preferences
            const targetDay = document.querySelector('input[name="target_day"]:checked')?.value;
            const timeBlock = document.querySelector('input[name="time_block"]:checked')?.value;
            
            responses.scheduling = {
                targetDay: targetDay,
                timeBlock: timeBlock
            };
            
            // Add custom date if selected
            if (targetDay === 'custom') {
                const customDate = document.getElementById('custom-date')?.value;
                if (customDate) {
                    responses.scheduling.customDate = customDate;
                }
            }
            
            // Add custom time range if selected
            if (timeBlock === 'custom') {
                const startTime = document.getElementById('custom-start-time')?.value;
                const endTime = document.getElementById('custom-end-time')?.value;
                if (startTime && endTime) {
                    responses.scheduling.customTimeRange = {
                        start: startTime,
                        end: endTime
                    };
                }
            }
            
            // Collect structured priorities with time estimates
            const priorities = [];
            for (let i = 1; i <= 3; i++) {
                const taskInput = document.getElementById(`priority-${i}`);
                const timeSelect = document.getElementById(`time-${i}`);
                
                if (taskInput && taskInput.value.trim()) {
                    priorities.push({
                        task: taskInput.value.trim(),
                        timeEstimate: timeSelect.value,
                        priority: i
                    });
                }
            }
            
            responses.priorities = priorities;
            
            try {
                showNotification('Processing your responses...', 'info');
                updateOrchestrationStatus('interview', '‚úÖ Complete');
                updateOrchestrationStatus('data', 'üîÑ Analyzing...');
                
                // Send responses to continue orchestration
                const response = await fetch('/api/productivity/orchestrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        responses: responses,
                        phase: 'analysis'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateOrchestrationStatus('data', '‚úÖ Complete');
                    updateOrchestrationStatus('analysis', '‚úÖ Complete');
                    updateOrchestrationStatus('schedule', 'üîÑ Building...');
                    
                    // Show analysis summary and continue to schedule building
                    showAnalysisSummary(data);
                    
                } else {
                    throw new Error(data.message || 'Analysis failed');
                }
                
            } catch (error) {
                console.error('Error submitting responses:', error);
                showNotification('Error processing responses. Please try again.', 'error');
            }
            
            hideInterview();
        }

        // Show analysis summary and continue to schedule
        async function showAnalysisSummary(analysisData) {
            console.log('üìä Analysis data received:', analysisData);
            
            const summaryHTML = `
                <div class="analysis-summary" id="analysis-summary">
                    <h3>üìä Analysis Complete</h3>
                    <p>Based on your responses, I've analyzed your optimal work patterns.</p>
                    <div class="analysis-actions">
                        <button class="btn primary" onclick="proceedToSchedule()">Build My Schedule</button>
                        <button class="btn secondary" onclick="hideAnalysis()">Review Analysis</button>
                    </div>
                </div>
            `;
            
            const statusDiv = document.getElementById('orchestration-status');
            statusDiv.innerHTML = summaryHTML;
            
            // Store analysis data for next step
            window.currentAnalysis = analysisData;
            
            // Auto-proceed to schedule building after brief pause
            setTimeout(() => {
                console.log('‚è∞ Auto-proceeding to schedule building...');
                proceedToSchedule();
            }, 2000);
        }

        // Proceed to schedule building
        async function proceedToSchedule() {
            try {
                updateOrchestrationStatus('schedule', 'üîÑ Building...');
                showNotification('Building your personalized schedule...', 'info');
                
                const response = await fetch('/api/productivity/orchestrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phase: 'schedule',
                        analysis: window.currentAnalysis.analysis,
                        userResponses: window.currentAnalysis.userResponses
                    })
                });
                
                const data = await response.json();
                console.log('üèóÔ∏è Schedule building response:', data);
                
                if (data.success) {
                    updateOrchestrationStatus('schedule', '‚úÖ Ready for Approval');
                    console.log('‚úÖ Schedule built successfully, showing approval');
                    showScheduleApproval(data.schedule);
                } else {
                    console.error('‚ùå Schedule building failed:', data);
                    throw new Error(data.message || 'Schedule building failed');
                }
                
            } catch (error) {
                console.error('Error building schedule:', error);
                showNotification('Error building schedule. Please try again.', 'error');
            }
        }

        // Show schedule for approval
        function showScheduleApproval(schedule) {
            console.log('üìã Showing schedule approval with data:', schedule);
            
            const scheduleHTML = `
                <div class="schedule-approval" id="schedule-approval">
                    <h3>üóìÔ∏è Your Personalized Schedule</h3>
                    <div class="schedule-preview">
                        ${formatScheduleForDisplay(schedule)}
                    </div>
                    <div class="schedule-actions">
                        <button class="btn primary" onclick="approveSchedule()">‚úÖ Approve & Start My Day</button>
                        <button class="btn secondary" onclick="requestModifications()">‚úèÔ∏è Request Changes</button>
                        <button class="btn tertiary" onclick="rejectSchedule()">‚ùå Start Over</button>
                    </div>
                </div>
            `;
            
            const statusDiv = document.getElementById('orchestration-status');
            statusDiv.innerHTML = scheduleHTML;
            
            // Store schedule data
            window.currentSchedule = schedule;
        }

        // Format schedule for display
        function formatScheduleForDisplay(schedule) {
            console.log('üóìÔ∏è Formatting schedule:', schedule);
            console.log('üîç Schedule type:', typeof schedule);
            console.log('üîç Schedule keys:', Object.keys(schedule || {}));
            
            if (!schedule) {
                console.log('‚ùå No schedule data received');
                return '<p>No schedule data received</p>';
            }
            
            // Check different possible structure formats
            let blocks = schedule.scheduleBlocks || schedule.schedule?.scheduleBlocks || schedule.blocks || schedule.timeBlocks || [];
            console.log('üîç Found blocks:', blocks);
            console.log('üîç Blocks length:', blocks?.length);
            
            if (!blocks || blocks.length === 0) {
                console.log('‚ùå No schedule blocks found in structure');
                return '<p>No schedule blocks found. Raw data: ' + JSON.stringify(schedule).substring(0, 200) + '...</p>';
            }
            
            return blocks.map(block => `
                <div class="schedule-block" style="margin: 10px 0; padding: 10px; border-left: 4px solid #4CAF50; background: rgba(255,255,255,0.1);">
                    <div style="font-weight: bold; color: #4CAF50;">${block.startTime} - ${block.endTime}</div>
                    <div style="font-size: 16px; margin: 5px 0;">${block.task || block.title}</div>
                    <div style="font-size: 14px; opacity: 0.8;">${block.description}</div>
                </div>
            `).join('');
        }

        // Approve schedule
        async function approveSchedule() {
            try {
                console.log('üöÄ Approving schedule with data:', window.currentSchedule);
                console.log('üìã Schedule blocks count:', window.currentSchedule?.scheduleBlocks?.length);
                
                showNotification('Activating your schedule...', 'info');
                
                const response = await fetch('/api/productivity/orchestrate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phase: 'approve',
                        schedule: window.currentSchedule
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateOrchestrationStatus('schedule', '‚úÖ Active');
                    showNotification('üéâ Your day is optimized and ready! Schedule activated.', 'success');
                    hideScheduleApproval();
                } else {
                    throw new Error(data.message || 'Schedule approval failed');
                }
                
            } catch (error) {
                console.error('Error approving schedule:', error);
                showNotification('Error activating schedule. Please try again.', 'error');
            }
        }

        // Hide various UI elements
        function hideAnalysis() {
            const container = document.getElementById('analysis-summary');
            if (container) container.remove();
        }

        function hideScheduleApproval() {
            const container = document.getElementById('schedule-approval');
            if (container) container.remove();
        }

        function requestModifications() {
            const schedule = window.currentSchedule;
            if (!schedule || !schedule.scheduleBlocks) {
                showNotification('No schedule to modify', 'error');
                return;
            }
            
            showScheduleEditor(schedule);
        }

        function rejectSchedule() {
            hideScheduleApproval();
            resetOrchestrationState();
            showNotification('Schedule rejected. Ready to start fresh!', 'info');
        }

        // Reset the entire orchestration state to start over
        async function resetOrchestrationState() {
            try {
                // Reset backend state
                const response = await fetch('/api/productivity/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (!response.ok) {
                    console.warn('Backend reset failed, continuing with frontend reset');
                }
                
                // Reset button state
                const startBtn = document.querySelector('.orchestrator-btn.primary');
                if (startBtn) {
                    startBtn.textContent = 'üöÄ Start My Day';
                    startBtn.disabled = false;
                }
                
                // Clear any stored data
                window.currentSchedule = null;
                window.currentInterview = null;
                
                // Hide any active UI elements
                const interviewContainer = document.getElementById('interview-container');
                if (interviewContainer) {
                    interviewContainer.style.display = 'none';
                }
                
                const statusDiv = document.getElementById('orchestration-status');
                if (statusDiv) {
                    statusDiv.style.display = 'none';
                }
                
                // Reset status indicators
                updateOrchestrationStatus('interview', '‚è≥ Pending');
                updateOrchestrationStatus('data', '‚è≥ Pending');
                updateOrchestrationStatus('analysis', '‚è≥ Pending');
                updateOrchestrationStatus('schedule', '‚è≥ Pending');
                
                console.log('üîÑ Orchestration state reset - ready for fresh start');
            } catch (error) {
                console.error('Reset error:', error);
                // Continue with frontend reset even if backend fails
            }
        }

        // Show schedule editor for modifications
        function showScheduleEditor(schedule) {
            const editorHTML = `
                <div class="schedule-editor" id="schedule-editor">
                    <h3>‚úèÔ∏è Edit Your Schedule</h3>
                    <div class="editor-blocks" id="editor-blocks">
                        ${renderEditableSchedule(schedule.scheduleBlocks)}
                    </div>
                    <div class="editor-actions">
                        <button class="btn primary" onclick="saveScheduleChanges()">üíæ Save Changes</button>
                        <button class="btn secondary" onclick="addNewBlock()">‚ûï Add Time Block</button>
                        <button class="btn tertiary" onclick="cancelEditing()">‚ùå Cancel</button>
                    </div>
                </div>
            `;
            
            const statusDiv = document.getElementById('orchestration-status');
            statusDiv.innerHTML = editorHTML;
        }

        // Render editable schedule blocks
        function renderEditableSchedule(blocks) {
            return blocks.map((block, index) => `
                <div class="editable-block" data-index="${index}">
                    <div class="time-inputs">
                        <input type="time" value="${block.startTime}" id="start-${index}" class="time-input">
                        <span>to</span>
                        <input type="time" value="${block.endTime}" id="end-${index}" class="time-input">
                    </div>
                    <div class="task-inputs">
                        <input type="text" value="${block.task || block.title || ''}" id="task-${index}" class="task-input" placeholder="Task name">
                        <textarea id="desc-${index}" class="desc-input" placeholder="Description">${block.description || ''}</textarea>
                    </div>
                    <div class="block-controls">
                        <select id="type-${index}" class="type-select">
                            <option value="pomodoro_work" ${block.type === 'pomodoro_work' ? 'selected' : ''}>üéØ Focus Work</option>
                            <option value="break" ${block.type === 'break' ? 'selected' : ''}>‚òï Break</option>
                            <option value="meeting" ${block.type === 'meeting' ? 'selected' : ''}>üë• Meeting</option>
                            <option value="admin" ${block.type === 'admin' ? 'selected' : ''}>üìã Admin Tasks</option>
                            <option value="email" ${block.type === 'email' ? 'selected' : ''}>üìß Email</option>
                        </select>
                        <button onclick="deleteBlock(${index})" class="delete-btn">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        // Validate schedule editor state
        function validateScheduleEditor() {
            const editor = document.getElementById('schedule-editor');
            if (!editor) {
                console.error('‚ùå Schedule editor not found');
                return false;
            }
            
            const blocksContainer = document.getElementById('editor-blocks');
            if (!blocksContainer) {
                console.error('‚ùå Editor blocks container not found');
                return false;
            }
            
            const editableBlocks = document.querySelectorAll('.editable-block');
            if (editableBlocks.length === 0) {
                console.warn('‚ö†Ô∏è No editable blocks found');
                return false;
            }
            
            console.log(`‚úÖ Schedule editor validation passed: ${editableBlocks.length} blocks found`);
            return true;
        }

        // Save schedule changes
        async function saveScheduleChanges() {
            // Validate editor state first
            if (!validateScheduleEditor()) {
                showNotification('Schedule editor is not properly initialized', 'error');
                return;
            }
            const blocks = [];
            const editableBlocks = document.querySelectorAll('.editable-block');
            
            console.log('üîß Found editable blocks:', editableBlocks.length);
            
            editableBlocks.forEach((blockEl, index) => {
                // Get the actual index from data attribute
                const blockIndex = blockEl.getAttribute('data-index') || index;
                console.log(`üîß Processing block ${blockIndex}`);
                
                // Get elements with null checks
                const startTimeEl = document.getElementById(`start-${blockIndex}`);
                const endTimeEl = document.getElementById(`end-${blockIndex}`);
                const taskEl = document.getElementById(`task-${blockIndex}`);
                const descEl = document.getElementById(`desc-${blockIndex}`);
                const typeEl = document.getElementById(`type-${blockIndex}`);
                
                console.log('üîß Elements found:', {
                    startTime: !!startTimeEl,
                    endTime: !!endTimeEl,
                    task: !!taskEl,
                    desc: !!descEl,
                    type: !!typeEl
                });
                
                if (!startTimeEl || !endTimeEl || !taskEl || !descEl || !typeEl) {
                    console.error(`‚ùå Missing elements for block ${blockIndex}`);
                    return;
                }
                
                const startTime = startTimeEl.value;
                const endTime = endTimeEl.value;
                const task = taskEl.value;
                const description = descEl.value;
                const type = typeEl.value;
                
                if (startTime && endTime && task) {
                    blocks.push({
                        startTime,
                        endTime,
                        task,
                        description,
                        type
                    });
                } else {
                    console.warn(`‚ö†Ô∏è Incomplete block ${blockIndex}: startTime=${startTime}, endTime=${endTime}, task=${task}`);
                }
            });
            
            if (blocks.length === 0) {
                showNotification('Please add at least one time block', 'error');
                return;
            }
            
            // Sort blocks by start time
            blocks.sort((a, b) => a.startTime.localeCompare(b.startTime));
            
            const modifiedSchedule = {
                ...window.currentSchedule,
                scheduleBlocks: blocks
            };
            
            try {
                showNotification('Saving schedule changes...', 'info');
                
                // Update the current schedule
                window.currentSchedule = modifiedSchedule;
                
                // Show the updated schedule for approval
                showScheduleApproval(modifiedSchedule);
                showNotification('Schedule updated! Review and approve your changes.', 'success');
                
            } catch (error) {
                console.error('Error saving schedule changes:', error);
                showNotification('Error saving changes. Please try again.', 'error');
            }
        }

        // Add new time block
        function addNewBlock() {
            const container = document.getElementById('editor-blocks');
            const existingBlocks = document.querySelectorAll('.editable-block');
            const index = existingBlocks.length;
            
            console.log(`‚ûï Adding new block with index ${index}`);
            
            // Calculate a reasonable start time based on existing blocks
            let startTime = "09:00";
            let endTime = "10:00";
            
            if (existingBlocks.length > 0) {
                const lastBlock = existingBlocks[existingBlocks.length - 1];
                const lastEndTime = lastBlock.querySelector('[id^="end-"]')?.value;
                if (lastEndTime) {
                    startTime = lastEndTime;
                    // Add 1 hour to end time
                    const [hours, minutes] = lastEndTime.split(':');
                    const newHour = (parseInt(hours) + 1) % 24;
                    endTime = `${newHour.toString().padStart(2, '0')}:${minutes}`;
                }
            }
            
            const newBlockHTML = `
                <div class="editable-block" data-index="${index}">
                    <div class="time-inputs">
                        <input type="time" value="${startTime}" id="start-${index}" class="time-input">
                        <span>to</span>
                        <input type="time" value="${endTime}" id="end-${index}" class="time-input">
                    </div>
                    <div class="task-inputs">
                        <input type="text" value="" id="task-${index}" class="task-input" placeholder="Task name">
                        <textarea id="desc-${index}" class="desc-input" placeholder="Description"></textarea>
                    </div>
                    <div class="block-controls">
                        <select id="type-${index}" class="type-select">
                            <option value="pomodoro_work">üéØ Focus Work</option>
                            <option value="break">‚òï Break</option>
                            <option value="meeting">üë• Meeting</option>
                            <option value="admin">üìã Admin Tasks</option>
                            <option value="email">üìß Email</option>
                        </select>
                        <button onclick="deleteBlock(${index})" class="delete-btn">üóëÔ∏è</button>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', newBlockHTML);
            console.log(`‚úÖ New block ${index} added successfully`);
        }

        // Delete a time block
        function deleteBlock(index) {
            console.log(`üóëÔ∏è Deleting block ${index}`);
            const block = document.querySelector(`[data-index="${index}"]`);
            if (block) {
                block.remove();
                console.log(`‚úÖ Block ${index} deleted`);
                
                // Re-index remaining blocks to prevent gaps
                const remainingBlocks = document.querySelectorAll('.editable-block');
                remainingBlocks.forEach((blockEl, newIndex) => {
                    const oldIndex = blockEl.getAttribute('data-index');
                    blockEl.setAttribute('data-index', newIndex);
                    
                    // Update all IDs within this block
                    const startInput = blockEl.querySelector(`#start-${oldIndex}`);
                    const endInput = blockEl.querySelector(`#end-${oldIndex}`);
                    const taskInput = blockEl.querySelector(`#task-${oldIndex}`);
                    const descInput = blockEl.querySelector(`#desc-${oldIndex}`);
                    const typeSelect = blockEl.querySelector(`#type-${oldIndex}`);
                    const deleteBtn = blockEl.querySelector(`button[onclick*="${oldIndex}"]`);
                    
                    if (startInput) startInput.id = `start-${newIndex}`;
                    if (endInput) endInput.id = `end-${newIndex}`;
                    if (taskInput) taskInput.id = `task-${newIndex}`;
                    if (descInput) descInput.id = `desc-${newIndex}`;
                    if (typeSelect) typeSelect.id = `type-${newIndex}`;
                    if (deleteBtn) deleteBtn.setAttribute('onclick', `deleteBlock(${newIndex})`);
                });
            } else {
                console.error(`‚ùå Block ${index} not found`);
            }
        }

        // Cancel editing
        function cancelEditing() {
            if (window.currentSchedule) {
                showScheduleApproval(window.currentSchedule);
            }
        }

        // Load current orchestration status
        async function loadOrchestrationStatus() {
            try {
                const response = await fetch('/api/productivity/status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    
                    // Update status display based on actual status structure
                    updateOrchestrationStatus('interview', status.interview.active ? 'üîÑ Active' : '‚úÖ Ready');
                    updateOrchestrationStatus('data', status.dataCollection.availableSources.length > 0 ? '‚úÖ Ready' : '‚è≥ Pending');
                    updateOrchestrationStatus('analysis', status.scheduleAnalysis.llmAvailable ? '‚úÖ Ready' : '‚è≥ Pending');
                    updateOrchestrationStatus('schedule', status.scheduleBuilder.llmAvailable ? '‚úÖ Ready' : '‚è≥ Pending');
                }
            } catch (error) {
                console.error('Failed to load orchestration status:', error);
                updateOrchestrationStatus('interview', '‚ùì Unknown');
                updateOrchestrationStatus('data', '‚ùì Unknown');
                updateOrchestrationStatus('analysis', '‚ùì Unknown');
                updateOrchestrationStatus('schedule', '‚ùì Unknown');
            }
        }

        // Simple notification function
        // Utility function to safely get element by ID
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`‚ö†Ô∏è Element not found: ${id}`);
            }
            return element;
        }

        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 400px;
                animation: slideIn 0.3s ease;
            `;
            notification.textContent = message;
            
            // Add to page
            document.body.appendChild(notification);
            
            // Remove after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

    </script>

    <!-- Email AI Chat FAB - Only show on emails section -->
    <button class="email-chat-fab" id="email-chat-fab" onclick="toggleEmailChat()" title="Ask AI to help with emails" style="display: none;">
        üìß
    </button>

    <!-- Email AI Chat Container -->
    <div id="ai-email-chat" class="ai-chat-container">
        <div class="chat-header">
            <h3>üìß AI Email Assistant</h3>
            <button class="chat-close" onclick="toggleEmailChat()">√ó</button>
        </div>
        
        <div class="chat-messages" id="email-chat-messages">
            <!-- Initial AI greeting message -->
            <div class="message ai">
                <div class="message-avatar">üìß</div>
                <div class="message-content">
                    Hi! I'm your AI email assistant. I can help you compose emails, reply to messages, and manage your inbox using natural language. Try saying:
                    <br><br>
                    ‚Ä¢ "Draft an email to John about the project update"
                    ‚Ä¢ "Help me reply to Sarah's message about the meeting"
                    ‚Ä¢ "Compose a professional follow-up email"
                    ‚Ä¢ "Write a thank you email to the team"
                </div>
            </div>
        </div>

        <div class="typing-indicator" id="email-typing-indicator">
            <div class="message-avatar">üìß</div>
            <div>
                AI is thinking
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <textarea 
                id="email-chat-input" 
                class="chat-input" 
                placeholder="Tell me what email you'd like to create..."
                onkeypress="handleEmailChatKeyPress(event)"
                rows="1"
            ></textarea>
        </div>
    </div>

</body>
</html>